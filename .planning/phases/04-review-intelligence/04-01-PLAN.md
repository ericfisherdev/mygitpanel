---
phase: 04-review-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/domain/model/review.go
  - internal/domain/model/reviewcomment.go
  - internal/domain/model/issuecomment.go
  - internal/domain/model/botconfig.go
  - internal/domain/model/enums.go
  - internal/domain/model/pullrequest.go
  - internal/domain/port/driven/githubclient.go
  - internal/domain/port/driven/reviewstore.go
  - internal/domain/port/driven/botconfigstore.go
  - internal/adapter/driven/sqlite/migrations/000003_add_reviews.up.sql
  - internal/adapter/driven/sqlite/migrations/000003_add_reviews.down.sql
  - internal/adapter/driven/sqlite/migrations/000004_add_review_comments.up.sql
  - internal/adapter/driven/sqlite/migrations/000004_add_review_comments.down.sql
  - internal/adapter/driven/sqlite/migrations/000005_add_issue_comments.up.sql
  - internal/adapter/driven/sqlite/migrations/000005_add_issue_comments.down.sql
  - internal/adapter/driven/sqlite/migrations/000006_add_bot_config.up.sql
  - internal/adapter/driven/sqlite/migrations/000006_add_bot_config.down.sql
  - internal/adapter/driven/sqlite/migrations/000007_add_head_sha.up.sql
  - internal/adapter/driven/sqlite/migrations/000007_add_head_sha.down.sql
  - internal/adapter/driven/sqlite/reviewrepo.go
  - internal/adapter/driven/sqlite/reviewrepo_test.go
  - internal/adapter/driven/sqlite/botconfigrepo.go
  - internal/adapter/driven/sqlite/botconfigrepo_test.go
autonomous: true

must_haves:
  truths:
    - "Review, ReviewComment, IssueComment, and BotConfig domain models exist as pure Go structs with no external dependencies"
    - "ReviewStore and BotConfigStore port interfaces are defined with methods for CRUD and query operations"
    - "GitHubClient port interface includes methods for all three comment types plus thread resolution"
    - "SQLite tables for reviews, review_comments, issue_comments, and bot_config exist with proper foreign keys"
    - "PullRequest model has HeadSHA field persisted in SQLite"
    - "SQLite adapters implement the new port interfaces with passing tests"
  artifacts:
    - path: "internal/domain/model/review.go"
      provides: "Review entity with CommitID for outdated detection"
      contains: "CommitID"
    - path: "internal/domain/model/reviewcomment.go"
      provides: "ReviewComment entity with StartLine, SubjectType, suggestion fields"
      contains: "StartLine"
    - path: "internal/domain/model/issuecomment.go"
      provides: "IssueComment entity for PR-level general comments"
      contains: "IssueComment"
    - path: "internal/domain/model/botconfig.go"
      provides: "BotConfig entity for configurable bot usernames"
      contains: "BotConfig"
    - path: "internal/domain/port/driven/reviewstore.go"
      provides: "ReviewStore port interface"
      exports: ["ReviewStore"]
    - path: "internal/domain/port/driven/botconfigstore.go"
      provides: "BotConfigStore port interface"
      exports: ["BotConfigStore"]
    - path: "internal/adapter/driven/sqlite/reviewrepo.go"
      provides: "SQLite implementation of ReviewStore"
      contains: "ReviewRepo"
    - path: "internal/adapter/driven/sqlite/botconfigrepo.go"
      provides: "SQLite implementation of BotConfigStore"
      contains: "BotConfigRepo"
  key_links:
    - from: "internal/adapter/driven/sqlite/reviewrepo.go"
      to: "internal/domain/port/driven/reviewstore.go"
      via: "compile-time interface check"
      pattern: "var _ driven\\.ReviewStore"
    - from: "internal/adapter/driven/sqlite/botconfigrepo.go"
      to: "internal/domain/port/driven/botconfigstore.go"
      via: "compile-time interface check"
      pattern: "var _ driven\\.BotConfigStore"
---

<objective>
Expand the domain model, port interfaces, and SQLite persistence layer to support reviews, review comments, issue comments, bot configuration, and HeadSHA tracking on pull requests.

Purpose: This is the data foundation for all Phase 4 features. Every subsequent plan depends on these types, interfaces, and tables existing.
Output: Expanded domain models, new port interfaces, 5 migrations, 2 new SQLite adapters with tests.
</objective>

<execution_context>
@/home/esfisher/.claude/get-shit-done/workflows/execute-plan.md
@/home/esfisher/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-review-intelligence/04-RESEARCH.md
@internal/domain/model/review.go
@internal/domain/model/reviewcomment.go
@internal/domain/model/pullrequest.go
@internal/domain/model/enums.go
@internal/domain/port/driven/githubclient.go
@internal/domain/port/driven/prstore.go
@internal/adapter/driven/sqlite/prrepo.go
@internal/adapter/driven/sqlite/prrepo_test.go
@internal/adapter/driven/sqlite/testhelper_test.go
@internal/adapter/driven/sqlite/migrations/000001_initial_schema.up.sql
@internal/adapter/driven/sqlite/migrations/000002_add_needs_review.up.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand domain models, enums, and port interfaces</name>
  <files>
    internal/domain/model/review.go
    internal/domain/model/reviewcomment.go
    internal/domain/model/issuecomment.go
    internal/domain/model/botconfig.go
    internal/domain/model/enums.go
    internal/domain/model/pullrequest.go
    internal/domain/port/driven/githubclient.go
    internal/domain/port/driven/reviewstore.go
    internal/domain/port/driven/botconfigstore.go
  </files>
  <action>
**Domain model changes:**

1. **review.go** -- Add `CommitID string` field to the existing Review struct (needed for outdated review detection via comparison with PR HeadSHA). Keep all existing fields.

2. **reviewcomment.go** -- Add fields to existing ReviewComment struct:
   - `StartLine int` (multi-line comment range start; 0 if single-line)
   - `SubjectType string` (from GitHub: "line" or "file" -- distinguishes inline from file-level)
   - `CommitID string` (which commit this comment targets)
   Keep all existing fields (ID, ReviewID, PRID, Author, Body, Path, Line, Side, DiffHunk, IsResolved, IsOutdated, InReplyToID, CreatedAt, UpdatedAt).

3. **issuecomment.go** -- NEW file. Create `IssueComment` struct for PR-level general comments (from GitHub Issues API, not Pull Requests API). Fields:
   - `ID int64`
   - `PRID int64` (links to PullRequest -- we store by PR, not by issue)
   - `Author string`
   - `Body string`
   - `IsBot bool`
   - `CreatedAt time.Time`
   - `UpdatedAt time.Time`

4. **botconfig.go** -- NEW file. Create `BotConfig` struct for configurable bot usernames:
   - `ID int64`
   - `Username string` (e.g., "coderabbitai", "github-actions[bot]")
   - `AddedAt time.Time`

5. **enums.go** -- Add `CommentType` typed string enum with constants:
   - `CommentTypeInline CommentType = "inline"` (review comment on a code line)
   - `CommentTypeGeneral CommentType = "general"` (issue comment / PR-level discussion)
   - `CommentTypeFile CommentType = "file"` (review comment on a file, not a line)

6. **pullrequest.go** -- Add `HeadSHA string` to PullRequest struct in the persisted fields section (between `NeedsReview` and `Labels`). This is needed for outdated review detection (compare review.CommitID against PR HeadSHA).

**Port interface changes:**

7. **githubclient.go** -- Add 2 new methods to the existing GitHubClient interface:
   - `FetchIssueComments(ctx context.Context, repoFullName string, prNumber int) ([]model.IssueComment, error)`
   - `FetchThreadResolution(ctx context.Context, repoFullName string, prNumber int) (map[int64]bool, error)` -- returns map of review comment database ID -> isResolved boolean. This is the GraphQL query data.
   Keep existing 3 methods unchanged.

8. **reviewstore.go** -- NEW file. Create `ReviewStore` interface:
   - `UpsertReview(ctx context.Context, review model.Review) error`
   - `UpsertReviewComment(ctx context.Context, comment model.ReviewComment) error`
   - `UpsertIssueComment(ctx context.Context, comment model.IssueComment) error`
   - `GetReviewsByPR(ctx context.Context, prID int64) ([]model.Review, error)`
   - `GetReviewCommentsByPR(ctx context.Context, prID int64) ([]model.ReviewComment, error)`
   - `GetIssueCommentsByPR(ctx context.Context, prID int64) ([]model.IssueComment, error)`
   - `UpdateCommentResolution(ctx context.Context, commentID int64, isResolved bool) error`
   - `DeleteReviewsByPR(ctx context.Context, prID int64) error` (for cleanup when PR is removed)

9. **botconfigstore.go** -- NEW file. Create `BotConfigStore` interface:
   - `Add(ctx context.Context, config model.BotConfig) error`
   - `Remove(ctx context.Context, username string) error`
   - `ListAll(ctx context.Context) ([]model.BotConfig, error)`
   - `GetUsernames(ctx context.Context) ([]string, error)` (convenience method returning just the username strings)

All port interfaces must use only `context.Context` and domain model types per project convention. Package: `driven`.
  </action>
  <verify>
`cd /home/esfisher/dev/mygitpanel && go build ./internal/domain/...` compiles without errors. All model structs have only stdlib imports (time). Port interfaces import only context and domain model.
  </verify>
  <done>
9 files created/modified. Review has CommitID. ReviewComment has StartLine, SubjectType, CommitID. IssueComment and BotConfig are new entities. PullRequest has HeadSHA. GitHubClient has 5 methods. ReviewStore and BotConfigStore port interfaces exist. All compile cleanly with no external dependencies in domain packages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SQLite migrations and adapter implementations with tests</name>
  <files>
    internal/adapter/driven/sqlite/migrations/000003_add_reviews.up.sql
    internal/adapter/driven/sqlite/migrations/000003_add_reviews.down.sql
    internal/adapter/driven/sqlite/migrations/000004_add_review_comments.up.sql
    internal/adapter/driven/sqlite/migrations/000004_add_review_comments.down.sql
    internal/adapter/driven/sqlite/migrations/000005_add_issue_comments.up.sql
    internal/adapter/driven/sqlite/migrations/000005_add_issue_comments.down.sql
    internal/adapter/driven/sqlite/migrations/000006_add_bot_config.up.sql
    internal/adapter/driven/sqlite/migrations/000006_add_bot_config.down.sql
    internal/adapter/driven/sqlite/migrations/000007_add_head_sha.up.sql
    internal/adapter/driven/sqlite/migrations/000007_add_head_sha.down.sql
    internal/adapter/driven/sqlite/reviewrepo.go
    internal/adapter/driven/sqlite/reviewrepo_test.go
    internal/adapter/driven/sqlite/botconfigrepo.go
    internal/adapter/driven/sqlite/botconfigrepo_test.go
  </files>
  <action>
**Migrations (10 files, each up + down):**

1. **000003_add_reviews** -- Create `reviews` table:
   ```sql
   CREATE TABLE IF NOT EXISTS reviews (
       id INTEGER PRIMARY KEY,          -- GitHub review ID (not autoincrement)
       pr_id INTEGER NOT NULL,          -- FK to pull_requests.id
       reviewer_login TEXT NOT NULL,
       state TEXT NOT NULL,             -- approved, changes_requested, commented, pending, dismissed
       body TEXT NOT NULL DEFAULT '',
       commit_id TEXT NOT NULL DEFAULT '',
       submitted_at DATETIME NOT NULL,
       is_bot INTEGER NOT NULL DEFAULT 0,
       FOREIGN KEY (pr_id) REFERENCES pull_requests(id) ON DELETE CASCADE
   );
   CREATE INDEX idx_reviews_pr_id ON reviews(pr_id);
   CREATE INDEX idx_reviews_reviewer ON reviews(reviewer_login);
   ```
   Down: `DROP TABLE IF EXISTS reviews;`

2. **000004_add_review_comments** -- Create `review_comments` table:
   ```sql
   CREATE TABLE IF NOT EXISTS review_comments (
       id INTEGER PRIMARY KEY,          -- GitHub comment ID
       review_id INTEGER NOT NULL DEFAULT 0,
       pr_id INTEGER NOT NULL,          -- FK to pull_requests.id
       author TEXT NOT NULL,
       body TEXT NOT NULL DEFAULT '',
       path TEXT NOT NULL DEFAULT '',
       line INTEGER NOT NULL DEFAULT 0,
       start_line INTEGER NOT NULL DEFAULT 0,
       side TEXT NOT NULL DEFAULT '',
       subject_type TEXT NOT NULL DEFAULT 'line',
       diff_hunk TEXT NOT NULL DEFAULT '',
       commit_id TEXT NOT NULL DEFAULT '',
       is_resolved INTEGER NOT NULL DEFAULT 0,
       is_outdated INTEGER NOT NULL DEFAULT 0,
       in_reply_to_id INTEGER,          -- NULL for root comments
       created_at DATETIME NOT NULL,
       updated_at DATETIME NOT NULL,
       FOREIGN KEY (pr_id) REFERENCES pull_requests(id) ON DELETE CASCADE
   );
   CREATE INDEX idx_review_comments_pr_id ON review_comments(pr_id);
   CREATE INDEX idx_review_comments_in_reply_to ON review_comments(in_reply_to_id);
   ```
   Down: `DROP TABLE IF EXISTS review_comments;`

3. **000005_add_issue_comments** -- Create `issue_comments` table:
   ```sql
   CREATE TABLE IF NOT EXISTS issue_comments (
       id INTEGER PRIMARY KEY,          -- GitHub comment ID
       pr_id INTEGER NOT NULL,
       author TEXT NOT NULL,
       body TEXT NOT NULL DEFAULT '',
       is_bot INTEGER NOT NULL DEFAULT 0,
       created_at DATETIME NOT NULL,
       updated_at DATETIME NOT NULL,
       FOREIGN KEY (pr_id) REFERENCES pull_requests(id) ON DELETE CASCADE
   );
   CREATE INDEX idx_issue_comments_pr_id ON issue_comments(pr_id);
   ```
   Down: `DROP TABLE IF EXISTS issue_comments;`

4. **000006_add_bot_config** -- Create `bot_config` table:
   ```sql
   CREATE TABLE IF NOT EXISTS bot_config (
       id INTEGER PRIMARY KEY AUTOINCREMENT,
       username TEXT NOT NULL UNIQUE,
       added_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
   );
   -- Seed default bot usernames
   INSERT INTO bot_config (username) VALUES ('coderabbitai');
   INSERT INTO bot_config (username) VALUES ('github-actions[bot]');
   INSERT INTO bot_config (username) VALUES ('copilot[bot]');
   ```
   Down: `DROP TABLE IF EXISTS bot_config;`

5. **000007_add_head_sha** -- Add head_sha to pull_requests:
   ```sql
   ALTER TABLE pull_requests ADD COLUMN head_sha TEXT NOT NULL DEFAULT '';
   ```
   Down: `ALTER TABLE pull_requests DROP COLUMN head_sha;`

**SQLite Adapters:**

6. **reviewrepo.go** -- Implement `driven.ReviewStore`:
   - Compile-time check: `var _ driven.ReviewStore = (*ReviewRepo)(nil)`
   - Constructor: `NewReviewRepo(db *DB) *ReviewRepo`
   - `UpsertReview`: INSERT ON CONFLICT(id) DO UPDATE for all fields. Use writer connection. Map `is_bot` bool to int 0/1.
   - `UpsertReviewComment`: INSERT ON CONFLICT(id) DO UPDATE. Map `is_resolved`, `is_outdated` bools to int 0/1. Handle nullable `in_reply_to_id` (sql.NullInt64 for scan, nil check for insert).
   - `UpsertIssueComment`: INSERT ON CONFLICT(id) DO UPDATE. Map `is_bot` bool to int.
   - `GetReviewsByPR`: SELECT from reviews WHERE pr_id = ? ORDER BY submitted_at. Use reader connection. Scan state as string, cast to model.ReviewState.
   - `GetReviewCommentsByPR`: SELECT from review_comments WHERE pr_id = ? ORDER BY created_at. Use reader. Convert int to bool for is_resolved, is_outdated. Handle nullable in_reply_to_id via sql.NullInt64.
   - `GetIssueCommentsByPR`: SELECT from issue_comments WHERE pr_id = ? ORDER BY created_at. Use reader.
   - `UpdateCommentResolution`: UPDATE review_comments SET is_resolved = ? WHERE id = ?. Use writer.
   - `DeleteReviewsByPR`: DELETE from reviews, review_comments, and issue_comments WHERE pr_id = ?. Use writer. Execute all three DELETEs (3 separate statements is fine -- each is atomic on its own, and this runs during stale cleanup).

   Follow the same scan pattern as prrepo.go: separate scanReview, scanReviewComment, scanIssueComment helper functions.

7. **reviewrepo_test.go** -- Tests using the existing testhelper_test.go setupTestDB pattern:
   - Test UpsertReview + GetReviewsByPR: insert 2 reviews for same PR, verify retrieval order by submitted_at.
   - Test UpsertReviewComment + GetReviewCommentsByPR: insert root comment and reply (with InReplyToID), verify both retrieved with correct fields including nullable in_reply_to_id.
   - Test UpsertIssueComment + GetIssueCommentsByPR: insert and verify.
   - Test UpdateCommentResolution: insert comment with is_resolved=false, update to true, verify.
   - Test DeleteReviewsByPR: insert reviews + comments for a PR, delete, verify all gone.
   - Test upsert idempotency: upsert same review twice with updated body, verify only one row with updated body.

8. **botconfigrepo.go** -- Implement `driven.BotConfigStore`:
   - Compile-time check: `var _ driven.BotConfigStore = (*BotConfigRepo)(nil)`
   - Constructor: `NewBotConfigRepo(db *DB) *BotConfigRepo`
   - `Add`: INSERT INTO bot_config (username, added_at) VALUES (?, ?). Use writer. Return error on unique constraint violation (caller handles conflict).
   - `Remove`: DELETE FROM bot_config WHERE username = ?. Use writer. Return error if no rows affected.
   - `ListAll`: SELECT id, username, added_at FROM bot_config ORDER BY username. Use reader.
   - `GetUsernames`: SELECT username FROM bot_config ORDER BY username. Use reader. Return []string.

9. **botconfigrepo_test.go** -- Tests:
   - Test Add + ListAll: verify seeded defaults (coderabbitai, github-actions[bot], copilot[bot]) exist after migration. Add a new one, verify 4 entries.
   - Test Add duplicate: attempt to add "coderabbitai" again, verify error.
   - Test Remove: remove "copilot[bot]", verify 2 remaining.
   - Test Remove nonexistent: verify error returned.
   - Test GetUsernames: verify returns []string with just the username values.

**Important patterns to follow:**
- Use the existing `parseTime` helper in the sqlite package for datetime parsing
- Use `scanner` interface pattern from prrepo.go for scan helpers
- Boolean fields: Go bool -> int 0/1 for writes, int != 0 -> bool for reads (matches IsDraft/NeedsReview pattern)
- Tests must create a PR first (via PRRepo.Upsert) before inserting reviews/comments that reference pr_id, since FK constraints are enforced
  </action>
  <verify>
`cd /home/esfisher/dev/mygitpanel && go test ./internal/adapter/driven/sqlite/... -v -count=1` -- all tests pass including new reviewrepo and botconfigrepo tests. `go build ./...` compiles. `go vet ./...` passes.
  </verify>
  <done>
5 migration pairs (10 SQL files) create reviews, review_comments, issue_comments, bot_config tables and add head_sha column. ReviewRepo implements ReviewStore with full CRUD and passes 6+ test cases. BotConfigRepo implements BotConfigStore with seeded defaults and passes 5+ test cases. All existing tests still pass.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles the entire project
2. `go test ./...` passes all tests (existing + new)
3. `go vet ./...` reports no issues
4. Domain model files import only `time` from stdlib
5. Port interfaces import only `context` and domain model types
6. New SQLite adapters have compile-time interface satisfaction checks
</verification>

<success_criteria>
- Domain model has 4 entity types (Review expanded, ReviewComment expanded, IssueComment new, BotConfig new)
- PullRequest has HeadSHA field
- 2 new port interfaces (ReviewStore with 8 methods, BotConfigStore with 4 methods)
- GitHubClient expanded to 5 methods (2 new: FetchIssueComments, FetchThreadResolution)
- 5 new migrations creating 4 tables and 1 column
- 2 new SQLite adapters with passing tests
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-review-intelligence/04-01-SUMMARY.md`
</output>
