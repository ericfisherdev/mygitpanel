---
phase: 08-review-workflows-and-attention-signals
plan: 04
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - internal/adapter/driving/web/handler.go
  - internal/adapter/driving/web/routes.go
  - internal/adapter/driving/web/viewmodel.go
  - internal/adapter/driving/web/viewmodel/viewmodel.go
  - internal/adapter/driving/web/templates/components/repo_settings.templ
  - internal/adapter/driving/web/templates/components/ignore_button.templ
  - internal/adapter/driving/web/templates/components/pr_card.templ
  - internal/adapter/driving/web/templates/pages/ignored_prs.templ
  - internal/adapter/driving/web/templates/partials/pr_list.templ
  - internal/adapter/driving/web/templates/partials/pr_detail_content.templ
autonomous: true

must_haves:
  truths:
    - "User can set required review count and urgency days per repo through a settings form"
    - "PRs are visually flagged in the sidebar when they have fewer approvals than the required count"
    - "PRs are visually flagged when they exceed the urgency days threshold"
    - "User can ignore a PR to hide it from the main feed"
    - "User can view the ignore list and un-ignore PRs to restore them to the feed"
    - "Ignored PRs are excluded from the main PR list and attention list"
  artifacts:
    - path: "internal/adapter/driving/web/templates/components/repo_settings.templ"
      provides: "Per-repo settings form for thresholds"
      contains: "required_review_count"
    - path: "internal/adapter/driving/web/templates/components/ignore_button.templ"
      provides: "Ignore/unignore toggle button"
      contains: "ignore"
    - path: "internal/adapter/driving/web/templates/pages/ignored_prs.templ"
      provides: "Ignore list page"
      contains: "ignored"
  key_links:
    - from: "internal/adapter/driving/web/handler.go"
      to: "internal/domain/port/driven/reposettingsstore.go"
      via: "settings read/write for threshold configuration"
      pattern: "repoSettingsStore\\.(Get|Set)Settings"
    - from: "internal/adapter/driving/web/handler.go"
      to: "internal/domain/port/driven/ignorestore.go"
      via: "ignore/unignore/list operations"
      pattern: "ignoreStore\\.(Ignore|Unignore|ListIgnored)"
    - from: "internal/adapter/driving/web/handler.go"
      to: "internal/domain/port/driven/ignorestore.go"
      via: "filter ignored PRs from main feed"
      pattern: "IsIgnored|ignoreStore"
---

<objective>
Add attention signals (per-repo thresholds with visual flags) and PR ignore list to the dashboard.

Purpose: Users need to customize what "needs attention" means per repo and hide noise. This plan delivers configurable urgency thresholds and the ability to ignore/restore PRs.

Output: Repo settings form, threshold-based visual flags on PR cards, ignore/unignore buttons, ignore list page.
</objective>

<execution_context>
@/home/esfisher/.claude/get-shit-done/workflows/execute-plan.md
@/home/esfisher/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-review-workflows-and-attention-signals/08-RESEARCH.md
@.planning/phases/08-review-workflows-and-attention-signals/08-01-SUMMARY.md
@internal/adapter/driving/web/handler.go
@internal/adapter/driving/web/routes.go
@internal/adapter/driving/web/viewmodel.go
@internal/adapter/driving/web/viewmodel/viewmodel.go
@internal/adapter/driving/web/templates/components/pr_card.templ
@internal/adapter/driving/web/templates/partials/pr_list.templ
@internal/adapter/driving/web/templates/partials/pr_detail_content.templ
@internal/adapter/driving/web/templates/components/repo_manager.templ
</context>

<tasks>

<task type="auto">
  <name>Task 1: Repo settings form and threshold-based visual flags</name>
  <files>
    internal/adapter/driving/web/handler.go
    internal/adapter/driving/web/routes.go
    internal/adapter/driving/web/viewmodel.go
    internal/adapter/driving/web/viewmodel/viewmodel.go
    internal/adapter/driving/web/templates/components/repo_settings.templ
    internal/adapter/driving/web/templates/components/pr_card.templ
    internal/adapter/driving/web/templates/partials/pr_list.templ
  </files>
  <action>
    **Handler methods (handler.go):**

    1. `GetRepoSettings(w, r)`: Extract owner/repo from path. Call repoSettingsStore.GetSettings(ctx, repoFullName). If nil, return defaults (RequiredReviewCount=2, UrgencyDays=7). Render repo_settings form partial.

    2. `SaveRepoSettings(w, r)`: ParseForm, validate CSRF. Extract required_review_count and urgency_days from form (parse as int, validate >= 0). Call repoSettingsStore.SetSettings(ctx, model.RepoSettings{...}). Return updated settings form with success banner via HTMX.

    **Register routes:**
    ```
    GET  /app/repos/{owner}/{repo}/settings -> h.GetRepoSettings
    POST /app/repos/{owner}/{repo}/settings -> h.SaveRepoSettings
    ```

    **Threshold flag logic in Dashboard/SearchPRs:**
    When building PR card view models, for each PR:
    1. Load repo settings from repoSettingsStore.GetSettings(ctx, pr.RepoFullName). Cache settings per repo within a single request to avoid N+1 queries (use a map[string]*model.RepoSettings loaded once for all distinct repos in the PR list).
    2. Count approved reviews for the PR. Use reviewSvc (if available) or add a lightweight method. For now, add a `GetApprovalCount(ctx, prID int64) (int, error)` method to ReviewStore port and implement it: `SELECT COUNT(DISTINCT author) FROM reviews WHERE pr_id=? AND state='APPROVED'`. Alternatively, if this is too much churn, use the existing review data already fetched â€” but for the list view we want lightweight. Best approach: add a `CountApprovals(ctx, prID int64) (int, error)` method to the ReviewStore port and SQLite adapter.
    3. Set flags on PRCardViewModel:
       - NeedsMoreReviews bool: approvalCount < settings.RequiredReviewCount
       - IsStale bool: pr.DaysSinceLastActivity() >= settings.UrgencyDays
       - ApprovalCount int, RequiredReviewCount int (for display "1/2 approvals")

    **Repo settings template (repo_settings.templ):**
    HTMX form POSTing to /app/repos/{owner}/{repo}/settings. Two number inputs: "Required review count" (default 2) and "Urgency threshold (days)" (default 7). Submit button. hx-target replaces itself. Include CSRF token. Styled with Tailwind, dark mode support.

    Where to access repo settings: Add a settings gear icon button on each repo in the repo manager component. Clicking it loads the settings form via hx-get into a modal or inline expandable section.

    **PR card visual flags (pr_card.templ):**
    Add visual indicators to PR cards in the sidebar:
    - "Needs reviews" badge (amber/orange) when NeedsMoreReviews is true, showing "1/2 approvals"
    - "Stale" badge (red) when IsStale is true, showing "X days inactive"
    These badges appear below the existing CI/review/merge status indicators. Use Tailwind badge classes.

    **View model additions (viewmodel.go):**
    Add to PRCardViewModel: NeedsMoreReviews bool, IsStale bool, ApprovalCount int, RequiredReviewCount int, DaysInactive int.
    Add RepoSettingsViewModel: RepoFullName string, Owner string, Repo string, RequiredReviewCount int, UrgencyDays int.
  </action>
  <verify>`templ generate` succeeds. `go build ./...` compiles. `go test ./...` passes. Start app and verify repo settings gear icon appears, form loads, and PR cards show threshold badges when applicable.</verify>
  <done>Repo settings form saves thresholds per repo. PR cards show "needs reviews" and "stale" badges based on configured thresholds. Settings default to 2 reviews / 7 days when not configured.</done>
</task>

<task type="auto">
  <name>Task 2: PR ignore list and dashboard filtering</name>
  <files>
    internal/adapter/driving/web/handler.go
    internal/adapter/driving/web/routes.go
    internal/adapter/driving/web/viewmodel.go
    internal/adapter/driving/web/viewmodel/viewmodel.go
    internal/adapter/driving/web/templates/components/ignore_button.templ
    internal/adapter/driving/web/templates/pages/ignored_prs.templ
    internal/adapter/driving/web/templates/partials/pr_detail_content.templ
    internal/adapter/driving/web/templates/partials/pr_list.templ
  </files>
  <action>
    **Handler methods (handler.go):**

    1. `IgnorePR(w, r)`: ParseForm, validate CSRF. Extract owner/repo/number from path. Call ignoreStore.Ignore(ctx, repoFullName, prNumber). Re-render the PR list partial (the ignored PR disappears from the feed). Use OOB swap to also update the PR detail panel to show "This PR is ignored" or redirect to empty state.

    2. `UnignorePR(w, r)`: Validate CSRF. Extract owner/repo/number from path. Call ignoreStore.Unignore(ctx, repoFullName, prNumber). Re-render the ignore list page (the PR reappears in the feed).

    3. `ListIgnoredPRs(w, r)`: Call ignoreStore.ListIgnored(ctx). For each ignored PR, load basic PR data from prStore.GetByNumber to get title/author. Render the ignored_prs page. If HTMX request (HX-Request header), render as partial; otherwise render full page with layout.

    **Filter ignored PRs from main feed:**
    In Dashboard and SearchPRs handlers, after loading PRs, filter out ignored ones. For efficiency: call ignoreStore.ListIgnored(ctx) once, build a set of "repoFullName:prNumber" strings, then filter the PR slice. This is O(n+m) and avoids N per-PR IsIgnored queries.

    **Register routes:**
    ```
    POST   /app/prs/{owner}/{repo}/{number}/ignore  -> h.IgnorePR
    DELETE /app/prs/{owner}/{repo}/{number}/ignore  -> h.UnignorePR
    GET    /app/ignored                              -> h.ListIgnoredPRs
    ```

    **Ignore button template (ignore_button.templ):**
    On PR detail view, show an "Ignore" button (eye-slash icon or similar). HTMX POST to /app/prs/{owner}/{repo}/{number}/ignore. hx-target="#pr-list" to refresh the sidebar list. Include CSRF token. For ignored PRs (shown on ignore list page), show "Restore" button that sends DELETE.

    **Ignored PRs page (ignored_prs.templ):**
    A page/partial listing ignored PRs in a table or card layout. Each row shows: PR title, repo, number, ignored date, and a "Restore" button (hx-delete to unignore endpoint). Add a link/button to access this page from the sidebar or settings area (e.g., "Ignored PRs (N)" link near the repo manager).

    **PR detail integration (pr_detail_content.templ):**
    Add the ignore button to the PR detail header area (near the draft toggle). If viewing an ignored PR (from the ignore list), show "This PR is ignored" banner with an unignore button instead.

    **Dashboard integration:**
    Add a "Ignored PRs (N)" link in the sidebar below the repo manager section. The count comes from ignoreStore.ListIgnored length, passed through the DashboardViewModel.

    **View model additions:**
    Add IgnoredPRViewModel: RepoFullName string, PRNumber int, Title string, Author string, IgnoredAt string.
    Add to DashboardViewModel: IgnoredCount int.
    Add to PRDetailViewModel: IsIgnored bool.
  </action>
  <verify>`templ generate` succeeds. `go build ./...` compiles. `go test ./...` passes. Start app and verify: ignore button on PR detail, ignored PRs disappear from feed, ignore list page shows ignored PRs with restore button.</verify>
  <done>User can ignore PRs (hidden from feed), view ignore list, and restore ignored PRs. Dashboard shows ignored count. Feed excludes ignored PRs.</done>
</task>

</tasks>

<verification>
- `templ generate` runs without errors
- `go build ./...` compiles
- `go test ./...` passes (including any new ReviewStore.CountApprovals test)
- PR cards show threshold-based visual flags
- Repo settings form saves and applies thresholds
- Ignored PRs are hidden from main feed
- Ignore list page shows all ignored PRs with restore option
</verification>

<success_criteria>
- Per-repo review count thresholds configurable via GUI form (ATT-01)
- Per-repo urgency days configurable via GUI form (ATT-02)
- PRs visually flagged when below review threshold or exceeding age threshold
- User can ignore a PR to hide it from feed (ATT-03)
- User can view ignore list and restore PRs (ATT-04)
- Ignored PRs still polled (display-layer filtering, not polling-layer)
</success_criteria>

<output>
After completion, create `.planning/phases/08-review-workflows-and-attention-signals/08-04-SUMMARY.md`
</output>
