---
phase: 08-review-workflows-and-attention-signals
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/domain/port/driven/githubclient.go
  - internal/adapter/driven/github/client.go
  - internal/adapter/driven/github/reviews_write.go
  - internal/adapter/driven/github/graphql.go
  - internal/application/clientprovider.go
  - internal/application/clientprovider_test.go
  - internal/config/config.go
autonomous: true

must_haves:
  truths:
    - "GitHubClient port includes 4 write methods (CreateReview, CreateIssueComment, ReplyToReviewComment, SetDraftStatus)"
    - "GitHub adapter implements all 4 write methods using go-github v82 and raw GraphQL"
    - "GitHubClientProvider enables runtime hot-swap of the GitHub client via RWMutex"
    - "Config.Load no longer fails when GitHub token/username env vars are missing"
  artifacts:
    - path: "internal/domain/port/driven/githubclient.go"
      provides: "Extended GitHubClient port with write methods"
      contains: "CreateReview"
    - path: "internal/adapter/driven/github/reviews_write.go"
      provides: "GitHub write method implementations"
      contains: "CreateReview"
    - path: "internal/application/clientprovider.go"
      provides: "GitHubClientProvider for credential hot-swap"
      exports: ["GitHubClientProvider"]
    - path: "internal/config/config.go"
      provides: "Config with optional GitHub credentials"
      contains: "LookupEnv"
  key_links:
    - from: "internal/adapter/driven/github/reviews_write.go"
      to: "internal/domain/port/driven/githubclient.go"
      via: "implements write methods"
      pattern: "func \\(c \\*Client\\) CreateReview"
    - from: "internal/application/clientprovider.go"
      to: "internal/domain/port/driven/githubclient.go"
      via: "holds and swaps GitHubClient instances"
      pattern: "driven\\.GitHubClient"
---

<objective>
Add GitHub write operations to the adapter and create the credential hot-swap mechanism. Also make config tolerant of missing GitHub credentials (they can now come from the GUI).

Purpose: Review workflows (comment, approve, request changes, draft toggle) need GitHub write methods. Credential management needs the ability to swap the GitHub client at runtime without restart.

Output: Extended GitHubClient port, 4 write methods on the adapter, GitHubClientProvider, flexible config.
</objective>

<execution_context>
@/home/esfisher/.claude/get-shit-done/workflows/execute-plan.md
@/home/esfisher/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-review-workflows-and-attention-signals/08-RESEARCH.md
@internal/domain/port/driven/githubclient.go
@internal/adapter/driven/github/client.go
@internal/adapter/driven/github/graphql.go
@internal/application/pollservice.go
@internal/config/config.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: GitHubClient write methods and GitHubClientProvider</name>
  <files>
    internal/domain/port/driven/githubclient.go
    internal/adapter/driven/github/reviews_write.go
    internal/adapter/driven/github/graphql.go
    internal/adapter/driven/github/client.go
    internal/application/clientprovider.go
    internal/application/clientprovider_test.go
  </files>
  <action>
    Extend the GitHubClient port interface in githubclient.go with 4 new write methods:
    ```
    CreateReview(ctx context.Context, repoFullName string, prNumber int, event string, body string) error
    CreateIssueComment(ctx context.Context, repoFullName string, prNumber int, body string) error
    ReplyToReviewComment(ctx context.Context, repoFullName string, prNumber int, commentID int64, body string) error
    SetDraftStatus(ctx context.Context, repoFullName string, prNumber int, nodeID string, draft bool) error
    ```

    Create `reviews_write.go` in the github adapter package with implementations for the first 3 methods following the research code examples exactly. Use the existing `splitRepo` helper and `logRateLimit` pattern. For CreateReview, event is one of "APPROVE", "REQUEST_CHANGES", "COMMENT". Use `gh.Ptr()` for pointer fields on request structs.

    Add `SetDraftStatus` to `graphql.go` following the existing `FetchThreadResolution` pattern for raw GraphQL HTTP requests. Define two const mutation strings: `markReadyMutation` and `convertToDraftMutation`. Choose mutation based on `draft` bool parameter. Variables map: `{"id": nodeID}`. Follow the same error handling and response parsing pattern as FetchThreadResolution. Return nil on success, wrapped error on failure.

    Verify the compile-time check `var _ driven.GitHubClient = (*Client)(nil)` in client.go still passes with the new methods.

    Create `clientprovider.go` in the application package:
    ```go
    type GitHubClientProvider struct {
        mu     sync.RWMutex
        client driven.GitHubClient
    }
    ```
    - `NewGitHubClientProvider(client driven.GitHubClient) *GitHubClientProvider` constructor
    - `Get() driven.GitHubClient` (read-lock)
    - `Replace(client driven.GitHubClient)` (write-lock)
    - `HasClient() bool` returns true if internal client is non-nil (read-lock)

    Create `clientprovider_test.go`:
    - Test Get returns initial client
    - Test Replace swaps client
    - Test HasClient returns false for nil, true after Replace
    - Test concurrent Get/Replace safety (use goroutines + sync.WaitGroup)
  </action>
  <verify>`go test ./internal/application/...` passes. `go build ./internal/adapter/driven/github/...` compiles. `go vet ./...` passes.</verify>
  <done>GitHubClient port has 4 write methods. GitHub adapter implements all 4. GitHubClientProvider supports thread-safe hot-swap. Tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Make config tolerant of missing GitHub credentials</name>
  <files>
    internal/config/config.go
  </files>
  <action>
    Modify `config.Load()` to make MYGITPANEL_GITHUB_TOKEN and MYGITPANEL_GITHUB_USERNAME optional:

    - Remove the `if !ok || token == ""` error returns for both env vars
    - Instead, use `os.Getenv()` with empty string fallback (or keep LookupEnv but accept empty)
    - The app starts with empty token/username; the credential store (from GUI) will provide them at runtime

    Add a helper method `HasGitHubCredentials() bool` on Config that returns true when both GitHubToken and GitHubUsername are non-empty. This will be used by the composition root to decide whether to create a real GitHub client at startup or start with a nil client in the provider.

    Keep backward compatibility: if env vars ARE set, everything works as before. If NOT set, the app starts but polling will be inactive until credentials are entered via GUI.

    Do NOT change PollInterval, ListenAddr, DBPath, or GitHubTeams handling.
  </action>
  <verify>`go build ./internal/config/...` compiles. `go test ./internal/config/...` passes (if config tests exist). Manually verify: unsetting MYGITPANEL_GITHUB_TOKEN no longer causes config.Load() to error.</verify>
  <done>Config.Load() succeeds with or without GitHub env vars. HasGitHubCredentials() correctly reports presence. Existing deployments with env vars work identically.</done>
</task>

</tasks>

<verification>
- `go build ./...` compiles the entire project
- `go test ./internal/application/...` passes including GitHubClientProvider tests
- `go test ./internal/adapter/driven/github/...` compiles (write methods may not have unit tests if they hit real API)
- `go vet ./...` has no issues
- Config loads successfully with and without GitHub env vars
</verification>

<success_criteria>
- GitHubClient port has 12+ methods (8 existing read + 4 new write)
- All 4 write methods implemented in GitHub adapter
- SetDraftStatus uses raw GraphQL mutations (not REST)
- GitHubClientProvider supports Get/Replace/HasClient with mutex safety
- Config.Load() is backward compatible but no longer requires GitHub credentials
</success_criteria>

<output>
After completion, create `.planning/phases/08-review-workflows-and-attention-signals/08-02-SUMMARY.md`
</output>
