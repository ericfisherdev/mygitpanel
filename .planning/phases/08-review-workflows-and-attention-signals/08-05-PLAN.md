---
phase: 08-review-workflows-and-attention-signals
plan: 05
type: execute
wave: 3
depends_on: [08-01, 08-02]
files_modified:
  - internal/application/attentionservice.go
  - internal/adapter/driven/sqlite/prrepo.go
  - internal/adapter/driving/web/handler.go
  - internal/adapter/driving/web/routes.go
  - internal/adapter/driving/web/viewmodel.go            # handler-layer helper: toPRCardViewModel, toPRDetailViewModel
  - internal/adapter/driving/web/viewmodel/viewmodel.go  # view model type definitions: PRCardViewModel, PRDetailViewModel
  - internal/adapter/driving/web/templates/components/pr_card.templ
  - internal/adapter/driving/web/templates/components/repo_threshold_popover.templ
  - internal/adapter/driving/web/templates/components/settings_drawer.templ
  - internal/adapter/driving/web/templates/partials/pr_list.templ
  - internal/adapter/driving/web/templates/partials/repo_list.templ
  - internal/adapter/driving/web/templates/pages/dashboard.templ
autonomous: false
requirements: [ATT-01, ATT-02, ATT-03, ATT-04]

must_haves:
  truths:
    - "PRs exceeding the review count threshold show a colored left border and a 'needs reviews' icon on their card"
    - "PRs open longer than the age urgency threshold show a colored left border and a clock icon"
    - "An ignored PR disappears from the sidebar PR list after clicking the ignore button"
    - "At the bottom of the sidebar PR list, 'Show ignored (N)' expands to show ignored PRs with restore buttons"
    - "User can click Restore on an ignored PR and it reappears in the main feed"
    - "Global threshold defaults (review count, age days) are configurable in the settings drawer"
    - "Each repo in the repo list has a settings icon that opens a per-repo threshold popover (review count override, age days override)"
    - "Saving per-repo threshold overrides triggers an OOB swap updating the PR list with recomputed signals"
    - "Saving a new global threshold triggers an OOB swap updating the PR list with recomputed signals"
  artifacts:
    - path: "internal/application/attentionservice.go"
      provides: "ComputeAttentionSignals pure function + AttentionService for threshold resolution"
      contains: "func ComputeAttentionSignals"
    - path: "internal/adapter/driven/sqlite/prrepo.go"
      provides: "ListAll and ListNeedingReview exclude ignored PRs; new ListIgnoredWithPRData method"
      contains: "LEFT JOIN ignored_prs"
    - path: "internal/adapter/driving/web/templates/components/pr_card.templ"
      provides: "PR card with attention signal border, icons, and ignore button"
      contains: "AttentionSignals"
    - path: "internal/adapter/driving/web/templates/components/settings_drawer.templ"
      provides: "Thresholds section with global settings form"
      contains: "review_count_threshold"
    - path: "internal/adapter/driving/web/templates/components/repo_threshold_popover.templ"
      provides: "Per-repo threshold override form (inline popover next to each repo in the repo list)"
      contains: "hx-post.*thresholds/repo"
  key_links:
    - from: "internal/adapter/driving/web/handler.go"
      to: "internal/application/attentionservice.go"
      via: "attentionSvc.SignalsForPR(ctx, pr, repoFullName) called when building PRCardViewModel"
      pattern: "SignalsForPR|ComputeAttentionSignals"
    - from: "internal/adapter/driving/web/templates/components/pr_card.templ"
      to: "internal/adapter/driving/web/viewmodel/viewmodel.go"
      via: "AttentionSignals field on PRCardViewModel drives border color and icons"
      pattern: "AttentionSignals"
    - from: "internal/adapter/driving/web/templates/partials/pr_list.templ"
      to: "/app/prs/{id}/ignore"
      via: "hx-post on ignore button; OOB swap refreshes #pr-list"
      pattern: "hx-post.*ignore"
    - from: "internal/adapter/driving/web/handler.go"
      to: "internal/adapter/driven/sqlite/prrepo.go"
      via: "ListAll and ListNeedingReview automatically exclude ignored PRs via JOIN"
      pattern: "LEFT JOIN ignored_prs"
---

<objective>
Implement attention signal computation, threshold configuration UI, and the PR ignore list. Attention signals are computed as a pure Go function in the application layer using data already in the database. The ignore list uses a collapsible "Show ignored (N)" section at the bottom of the sidebar.

Purpose: Delivers ATT-01 through ATT-04. This is the final plan of Phase 8 — after this plan, all Phase 8 success criteria are met.

Output: AttentionService with pure ComputeAttentionSignals function, PR card visual attention signals (colored border + icons), global threshold settings form in the drawer, per-repo threshold overrides, ignore/unignore buttons with OOB PR list updates, and the collapsible ignored list.
</objective>

<execution_context>
@/home/ericfisher/.claude/get-shit-done/workflows/execute-plan.md
@/home/ericfisher/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-review-workflows-and-attention-signals/08-CONTEXT.md
@.planning/phases/08-review-workflows-and-attention-signals/08-RESEARCH.md
@.planning/phases/08-review-workflows-and-attention-signals/08-02-SUMMARY.md
@internal/domain/model/attention.go
@internal/domain/model/pullrequest.go
@internal/domain/model/review.go
@internal/domain/port/driven/thresholdstore.go
@internal/domain/port/driven/ignorestore.go
@internal/adapter/driven/sqlite/prrepo.go
@internal/adapter/driving/web/handler.go
@internal/adapter/driving/web/viewmodel/viewmodel.go
@internal/adapter/driving/web/templates/components/pr_card.templ
@internal/adapter/driving/web/templates/partials/pr_list.templ
@internal/adapter/driving/web/templates/components/settings_drawer.templ
</context>

<tasks>

<task type="auto">
  <name>Task 1: AttentionService, prrepo ignore filtering, threshold settings form</name>
  <files>
    internal/application/attentionservice.go
    internal/adapter/driven/sqlite/prrepo.go
    internal/adapter/driving/web/handler.go
    internal/adapter/driving/web/routes.go
    internal/adapter/driving/web/viewmodel/viewmodel.go
    internal/adapter/driving/web/templates/components/settings_drawer.templ
  </files>
  <action>
    **internal/application/attentionservice.go — new file:**

    Pure function (exported, testable):
    ```go
    // ComputeAttentionSignals evaluates a PR against effective thresholds and returns
    // which attention signals are active. approvalCount is the number of approved reviews
    // from non-bot reviewers. authenticatedUserReviewSHA is the commit SHA of the
    // authenticated user's most recent review on this PR (empty string if no review exists).
    func ComputeAttentionSignals(
        pr model.PullRequest,
        approvalCount int,
        authenticatedUserReviewSHA string, // empty = no review yet
        thresholds model.EffectiveThresholds,
        authenticatedUser string,
    ) model.AttentionSignals
    ```
    Logic:
    - NeedsMoreReviews: approvalCount < thresholds.ReviewCountThreshold
    - IsAgeUrgent: pr.DaysSinceOpened() >= thresholds.AgeUrgencyDays
    - HasStaleReview: thresholds.StaleReviewEnabled &&
        authenticatedUserReviewSHA != "" &&
        authenticatedUserReviewSHA != pr.HeadSHA
      (non-empty reviewSHA means user has reviewed; if it doesn't match head, it's stale)
    - HasCIFailure: thresholds.CIFailureEnabled &&
        pr.Author == authenticatedUser &&
        pr.CIStatus == model.CIStatusFailing

    AttentionService struct (for use by the web handler):
    ```go
    type AttentionService struct {
        thresholdStore driven.ThresholdStore
        reviewStore    driven.ReviewStore
        username       string
    }

    func NewAttentionService(ts driven.ThresholdStore, rs driven.ReviewStore, username string) *AttentionService

    // EffectiveThresholdsFor returns the resolved thresholds for a repo (global + per-repo merge).
    func (s *AttentionService) EffectiveThresholdsFor(ctx context.Context, repoFullName string) (model.EffectiveThresholds, error)

    // SignalsForPR computes attention signals for a single PR. It fetches the required
    // review data from the review store. Returns zero-value AttentionSignals on error
    // (non-fatal — signals degrade gracefully).
    func (s *AttentionService) SignalsForPR(ctx context.Context, pr model.PullRequest) (model.AttentionSignals, error)
    ```

    EffectiveThresholdsFor merges global settings and per-repo overrides:
    - Fetch global settings; on error use DefaultGlobalSettings()
    - Fetch per-repo threshold; on sql.ErrNoRows use nil pointers (use globals)
    - For each field: if repo override pointer is non-nil, use it; else use global value
    - Return model.EffectiveThresholds with resolved values

    SignalsForPR:
    - Fetch reviews for pr.RepoFullName + pr.Number from reviewStore
    - Count approvals: reviews where State == "approved" and not a bot review
    - Find authenticated user's most recent review: filter reviews by s.username,
      sort by SubmittedAt DESC, take first, record CommitID
    - Call EffectiveThresholdsFor(ctx, pr.RepoFullName)
    - Call ComputeAttentionSignals(pr, approvalCount, userReviewSHA, thresholds, s.username)

    Write unit tests for ComputeAttentionSignals in attentionservice_test.go covering:
    - NeedsMoreReviews: 0 approvals with threshold 1 → true; 1 approval with threshold 1 → false
    - IsAgeUrgent: 8 days open with threshold 7 → true; 6 days → false
    - HasStaleReview: different SHAs → true; same SHA → false; empty reviewSHA → false
    - HasCIFailure: own PR failing CI → true; other's PR failing CI → false; own passing → false
    - HasAny() and Severity() basic checks

    **internal/adapter/driven/sqlite/prrepo.go — filter ignored PRs from ListAll and ListNeedingReview:**
    Add `LEFT JOIN ignored_prs ip ON ip.pr_id = pr.id WHERE ip.pr_id IS NULL`
    to both ListAll and ListNeedingReview queries (the WHERE clause excludes rows with a
    matching ignore record). This ensures ignored PRs are transparently hidden from the
    main feed without requiring callers to filter.

    Add new method ListIgnoredWithPRData:
    ```go
    // ListIgnoredWithPRData returns all ignored PRs with their pull request data.
    // Used for the ignore list UI.
    func (r *PRRepo) ListIgnoredWithPRData(ctx context.Context) ([]model.PullRequest, error)
    ```
    This is a JOIN query: `SELECT pr.* FROM pull_requests pr INNER JOIN ignored_prs ip ON ip.pr_id = pr.id ORDER BY ip.ignored_at DESC`.

    **internal/adapter/driving/web/viewmodel/viewmodel.go:**
    Add AttentionSignals field to PRCardViewModel:
    ```go
    Attention model.AttentionSignals
    ```
    This allows the PR card template to access signal booleans and severity.

    Update toPRCardViewModel in viewmodel.go to accept model.AttentionSignals and
    set it on the PRCardViewModel.

    **internal/adapter/driving/web/handler.go:**
    Add attentionSvc *application.AttentionService to Handler struct and NewHandler params.
    Update Dashboard, SearchPRs, and AddRepo/RemoveRepo response rendering to compute
    attention signals per PR and pass them to toPRCardViewModel.
    Wrap signal computation in a non-fatal pattern (on error, use zero-value AttentionSignals
    and log a warning — same pattern as existing review enrichment).

    Add handlers:
    - IgnorePR: POST /app/prs/{id}/ignore — calls ignoreStore.Ignore(ctx, prID),
      returns OOB swap re-rendering #pr-list (same pattern as AddRepo OOB swap)
    - UnignorePR: POST /app/prs/{id}/unignore — calls ignoreStore.Unignore(ctx, prID),
      returns OOB swap re-rendering #pr-list

    Add threshold settings handlers:
    - SaveGlobalThresholds: POST /app/settings/thresholds/global — parse form fields
      (review_count_threshold, age_urgency_days, stale_review_enabled, ci_failure_enabled),
      call thresholdStore.SetGlobalSettings, then return OOB swap re-rendering #pr-list
      (so PR cards immediately reflect the new thresholds), plus a success fragment for
      hx-target="#threshold-status".
    - SaveRepoThreshold: POST /app/settings/thresholds/repo — parse form fields for a
      specific repo, call thresholdStore.SetRepoThreshold, return OOB swap.

    **internal/adapter/driving/web/routes.go:**
    ```go
    mux.HandleFunc("POST /app/prs/{id}/ignore", h.IgnorePR)
    mux.HandleFunc("POST /app/prs/{id}/unignore", h.UnignorePR)
    mux.HandleFunc("POST /app/settings/thresholds/global", h.SaveGlobalThresholds)
    mux.HandleFunc("POST /app/settings/thresholds/repo", h.SaveRepoThreshold)
    mux.HandleFunc("DELETE /app/settings/thresholds/repo/{owner}/{repo}", h.DeleteRepoThreshold)
    ```

    **internal/adapter/driving/web/templates/components/repo_threshold_popover.templ — new file:**
    Per-repo threshold override form rendered as a small popover next to each repo name in
    the repo list (sidebar). The popover is controlled by Alpine x-data/x-show inline on the repo row.

    The popover contains:
    - Hidden field: name="repo_full_name", value={repo.FullName}
    - Number input: "Min approvals" (name="review_count", placeholder="global default")
    - Number input: "Age urgency (days)" (name="age_urgency_days", placeholder="global default")
    - Save button: hx-post="/app/settings/thresholds/repo", hx-target="#repo-threshold-status-{repoSlug}",
      hx-swap="innerHTML", hx-include="closest form"
    - "Reset to global" link: hx-delete="/app/settings/thresholds/repo/{owner}/{repo}",
      same target, hx-swap="innerHTML"
    - Status div id="repo-threshold-status-{repoSlug}"

    The trigger is a small gear icon (⚙) inline after the repo name in the repo list.
    On click: `@click="thresholdOpen = !thresholdOpen"` inside an `x-data="{ thresholdOpen: false }"`
    wrapper on the repo list row. The popover panel uses `x-show="thresholdOpen"`.

    Populate inputs with current per-repo threshold values if they exist (pass RepoThreshold to the
    component; nil pointer fields render as empty inputs showing global fallback as placeholder).

    **internal/adapter/driving/web/templates/partials/repo_list.templ:**
    Update the repo list partial to include the per-repo threshold popover next to each repo name.
    Pass the per-repo RepoThreshold data to each row (fetch all repo thresholds in the handler
    when building the repo list view model).

    Add DeleteRepoThreshold handler: removes the per-repo row from repo_thresholds, returns a
    success fragment "Reset to global defaults" and triggers OOB swap of #pr-list.

    **internal/adapter/driving/web/templates/components/settings_drawer.templ:**
    Replace the threshold section placeholder with a real form:
    - Input: "Minimum approvals required" (number, name="review_count_threshold", default 1)
    - Input: "Age urgency threshold (days)" (number, name="age_urgency_days", default 7)
    - Toggle: "Flag stale reviews" (checkbox, name="stale_review_enabled")
    - Toggle: "Flag own PRs with CI failures" (checkbox, name="ci_failure_enabled")
    - Save button: hx-post="/app/settings/thresholds/global",
      hx-target="#threshold-status", hx-swap="innerHTML",
      hx-include="closest form"
    - Status div id="threshold-status"
    Pass the current GlobalSettings values to the drawer component so inputs show
    current state. Update SettingsDrawer component signature to accept GlobalSettings.
    Update the layout.templ render call to fetch and pass GlobalSettings.

    Run `templ generate`.
  </action>
  <verify>
    go test ./internal/application/... -v -run TestComputeAttentionSignals passes
    go build ./... succeeds
    go test ./... passes
    Manual: start server, open dashboard — PR cards show no border on PRs within thresholds
    Manual: in settings drawer, set age_urgency_days to 0 — all open PRs get colored border
    Manual: restore age_urgency_days to 7 — borders removed from within-threshold PRs
  </verify>
  <done>
    AttentionService computes signals from real DB data. PR cards show attention signals.
    Threshold settings form in drawer saves and triggers PR list OOB refresh.
    PRRepo.ListAll excludes ignored PRs automatically.
  </done>
</task>

<task type="auto">
  <name>Task 2: PR card attention visuals and ignore list UI</name>
  <files>
    internal/adapter/driving/web/templates/components/pr_card.templ
    internal/adapter/driving/web/templates/partials/pr_list.templ
    internal/adapter/driving/web/templates/pages/dashboard.templ
    internal/adapter/driving/web/viewmodel.go
  </files>
  <action>
    **internal/adapter/driving/web/templates/components/pr_card.templ:**
    Add attention signal visual treatment to the existing PR card:

    1. Colored left border based on severity:
       Add `border-l-4` to the card's outer div, with color based on Attention.Severity():
       - 0: no border change (default border-l-4 border-l-transparent)
       - 1: border-l-orange-400
       - 2: border-l-orange-500
       - 3 or 4: border-l-red-500
       Use a Go helper function attentionBorderClass(severity int) string in the component file.

    2. Attention signal icons (inline, small, below the PR title):
       Show a row of icons for active signals. Use inline SVG or emoji-free Unicode.
       All icons are small (w-4 h-4 inline):
       - NeedsMoreReviews: person/users icon, text-orange-500, title="Needs more reviews"
       - IsAgeUrgent: clock icon, text-red-500, title="PR is stale (open too long)"
       - HasStaleReview: refresh/outdated icon, text-yellow-500, title="Your review is outdated"
       - HasCIFailure: x-circle icon, text-red-600, title="CI is failing on your PR"
       Only render the icon if the corresponding bool is true.
       If no signals: render nothing extra (no empty icon row).

    3. Ignore button: a small "..." or X button on the card, visible on hover:
       ```templ
       <button
           hx-post={ fmt.Sprintf("/app/prs/%d/ignore", pr.ID) }
           hx-target="#pr-list"
           hx-swap="morph"
           class="opacity-0 group-hover:opacity-100 transition-opacity text-gray-400 hover:text-red-500"
           title="Ignore this PR"
       >
           <!-- x icon SVG -->
       </button>
       ```
       Add `group` class to the outer card div to enable group-hover.
       The PRCardViewModel needs an ID int64 field (the database PR ID, not the GitHub number)
       for the ignore endpoint. Add ID to PRCardViewModel and populate it in toPRCardViewModel.

    **internal/adapter/driving/web/viewmodel.go:**
    Update toPRCardViewModel to set ID = pr.ID on the PRCardViewModel.
    Update toPRCardViewModels and toPRCardViewModel to accept and pass AttentionSignals.
    The function signature becomes:
    ```go
    func toPRCardViewModel(pr model.PullRequest, signals model.AttentionSignals) vm.PRCardViewModel
    ```
    All callers updated accordingly.

    **internal/adapter/driving/web/templates/partials/pr_list.templ:**
    The existing PR list partial renders the active feed. Add a collapsible section below it
    for ignored PRs:

    Pass ignored PRs as a separate slice to the partial. Update PRListPartialViewModel
    (or the template signature) to accept `IgnoredPRs []PRCardViewModel`.

    Collapsible section:
    ```templ
    if len(ignoredPRs) > 0 {
        <div x-data="{ ignoredOpen: false }" class="mt-4 border-t border-gray-200 dark:border-gray-700 pt-2">
            <button
                @click="ignoredOpen = !ignoredOpen"
                class="w-full text-left text-xs text-gray-400 dark:text-gray-500 hover:text-gray-600 px-2 py-1 flex items-center justify-between"
            >
                <span x-text={ fmt.Sprintf("'Show ignored (%d)'", len(ignoredPRs)) }></span>
                <!-- chevron icon, rotates when open -->
                <svg x-bind:class="ignoredOpen ? 'rotate-180' : ''" .../>
            </button>
            <div x-show="ignoredOpen" x-transition class="mt-1 space-y-1">
                for _, pr := range ignoredPRs {
                    <div class="flex items-center justify-between px-2 py-1 rounded text-sm text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-900/50">
                        <span class="truncate">{ pr.Repository } #{ fmt.Sprint(pr.Number) } { pr.Title }</span>
                        <button
                            hx-post={ fmt.Sprintf("/app/prs/%d/unignore", pr.ID) }
                            hx-target="#pr-list"
                            hx-swap="morph"
                            class="ml-2 shrink-0 text-xs text-indigo-500 hover:underline"
                        >Restore</button>
                    </div>
                }
            </div>
        </div>
    }
    ```

    **internal/adapter/driving/web/templates/pages/dashboard.templ:**
    Update the Dashboard page to pass ignored PRs to the PR list partial.
    The dashboard view model (DashboardViewModel) needs an IgnoredPRs []vm.PRCardViewModel field.

    **handler.go (Dashboard and OOB helpers):**
    When building the DashboardViewModel, call prStore.ListIgnoredWithPRData(ctx), convert
    to PRCardViewModels with zero-value AttentionSignals (ignored PRs don't show signals),
    and set on the view model.
    The OOB PR list re-render (used by IgnorePR, UnignorePR, SaveGlobalThresholds) also
    fetches and includes the ignored list.

    Run `templ generate` after all .templ changes.
  </action>
  <verify>
    templ generate succeeds
    go build ./... succeeds
    go test ./... passes
    Manual: open dashboard — PR cards within thresholds have no colored border
    Manual: PR open > 7 days — clock icon + orange/red border visible on card
    Manual: hover over a PR card — X (ignore) button appears
    Manual: click ignore on a PR — PR disappears from feed immediately (morph swap)
    Manual: "Show ignored (1)" section appears at bottom — expand it, see ignored PR
    Manual: click Restore — PR reappears in the main feed
  </verify>
  <done>
    ATT-01 + ATT-02: PRs with review count or age exceeding thresholds show colored border and icons.
    ATT-03: Ignore button on cards; ignored PRs hidden from main feed.
    ATT-04: Collapsible "Show ignored (N)" list with Restore buttons.
    Threshold settings form in drawer saves and triggers OOB refresh.
  </done>
</task>

</tasks>

<verification>
1. go build ./... succeeds
2. go test ./... passes (including new ComputeAttentionSignals unit tests)
3. templ generate succeeds
4. PR card shows colored left border and icons when attention thresholds are exceeded
5. Ignore button on card hover → click → PR disappears from feed
6. "Show ignored (N)" expands → Restore click → PR reappears in feed
7. Settings drawer global thresholds form → save → PR list refreshes with updated signals
8. Repo list: gear icon next to each repo → popover opens → set per-repo override → save → PR list updates
9. "Reset to global" in per-repo popover → clears override → PR list reverts to global threshold behavior
10. ListAll and ListNeedingReview automatically exclude ignored PRs (verified by test or manual check)
</verification>

<success_criteria>
- ATT-01: Review count threshold configured in settings drawer; PRs below threshold show visual flag
- ATT-02: Age urgency threshold configured; PRs exceeding age show visual flag
- ATT-03: Ignore button on PR cards; ignored PRs removed from main feed
- ATT-04: Collapsible ignored list at bottom of sidebar with restore functionality
- ComputeAttentionSignals is a pure testable function in the application layer
- All Phase 8 success criteria met: CRED-01, CRED-02, REV-01-04, ATT-01-04
</success_criteria>

<output>
After completion, create `.planning/phases/08-review-workflows-and-attention-signals/08-05-SUMMARY.md`
</output>
