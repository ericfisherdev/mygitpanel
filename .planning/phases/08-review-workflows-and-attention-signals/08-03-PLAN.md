---
phase: 08-review-workflows-and-attention-signals
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - cmd/mygitpanel/main.go
  - internal/adapter/driven/github/client.go
  - internal/adapter/driven/github/pullrequests.go
  - internal/application/pollservice.go
  - internal/adapter/driving/web/handler.go
  - internal/adapter/driving/web/routes.go
  - internal/adapter/driving/web/viewmodel.go
  - internal/adapter/driving/web/viewmodel/viewmodel.go
  - internal/adapter/driving/web/templates/components/credential_form.templ
  - internal/adapter/driving/web/templates/components/review_form.templ
  - internal/adapter/driving/web/templates/components/comment_reply.templ
  - internal/adapter/driving/web/templates/components/draft_toggle.templ
  - internal/adapter/driving/web/templates/partials/pr_detail_content.templ
  - internal/adapter/driving/web/templates/partials/credential_status.templ
autonomous: true

must_haves:
  truths:
    - "User can enter GitHub token and username through a GUI form and credentials are saved to SQLite"
    - "Saved credentials are hot-swapped into the polling engine without restart"
    - "User can submit a review (approve, request changes, comment) on a PR from the detail view"
    - "User can reply to a review comment inline from the threaded conversation view"
    - "User can toggle a PR between draft and ready status from the detail view"
    - "Composition root wires GitHubClientProvider through PollService and web handler"
  artifacts:
    - path: "cmd/mygitpanel/main.go"
      provides: "Rewired composition root with GitHubClientProvider and new stores"
      contains: "GitHubClientProvider"
    - path: "internal/adapter/driving/web/templates/components/credential_form.templ"
      provides: "Credential input form"
      contains: "hx-post"
    - path: "internal/adapter/driving/web/templates/components/review_form.templ"
      provides: "Review submission form with radio buttons"
      contains: "APPROVE"
    - path: "internal/adapter/driving/web/templates/components/draft_toggle.templ"
      provides: "Draft toggle button"
      contains: "draft"
  key_links:
    - from: "cmd/mygitpanel/main.go"
      to: "internal/application/clientprovider.go"
      via: "constructor injection"
      pattern: "NewGitHubClientProvider"
    - from: "internal/adapter/driving/web/handler.go"
      to: "internal/application/clientprovider.go"
      via: "Replace call on credential save"
      pattern: "provider\\.Replace"
    - from: "internal/adapter/driving/web/handler.go"
      to: "internal/domain/port/driven/githubclient.go"
      via: "write method calls for reviews/comments/draft"
      pattern: "CreateReview|ReplyToReviewComment|SetDraftStatus"
---

<objective>
Wire credential management and review workflows end-to-end: composition root rewire, credential GUI with hot-swap, review submission form, comment reply, and draft toggle.

Purpose: This plan delivers the core write-capability transformation -- users can authenticate via the GUI and interact with PRs (review, comment, toggle draft) without leaving the dashboard.

Output: Working credential form, review submission, comment reply, draft toggle -- all connected to GitHub API via hot-swappable client.
</objective>

<execution_context>
@/home/esfisher/.claude/get-shit-done/workflows/execute-plan.md
@/home/esfisher/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-review-workflows-and-attention-signals/08-RESEARCH.md
@.planning/phases/08-review-workflows-and-attention-signals/08-01-SUMMARY.md
@.planning/phases/08-review-workflows-and-attention-signals/08-02-SUMMARY.md
@cmd/mygitpanel/main.go
@internal/application/pollservice.go
@internal/adapter/driving/web/handler.go
@internal/adapter/driving/web/routes.go
@internal/adapter/driving/web/viewmodel.go
@internal/adapter/driving/web/viewmodel/viewmodel.go
@internal/adapter/driving/web/templates/partials/pr_detail_content.templ
@internal/adapter/driving/web/templates/components/pr_detail.templ
@internal/adapter/driven/github/client.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Composition root rewire and credential management</name>
  <files>
    cmd/mygitpanel/main.go
    internal/application/pollservice.go
    internal/adapter/driven/github/client.go
    internal/adapter/driven/github/pullrequests.go
    internal/adapter/driving/web/handler.go
    internal/adapter/driving/web/routes.go
    internal/adapter/driving/web/viewmodel.go
    internal/adapter/driving/web/viewmodel/viewmodel.go
    internal/adapter/driving/web/templates/components/credential_form.templ
    internal/adapter/driving/web/templates/partials/credential_status.templ
  </files>
  <action>
    **Composition root (main.go):**
    1. Instantiate new stores after existing ones: credentialStore := sqliteadapter.NewCredentialRepo(db), repoSettingsStore := sqliteadapter.NewRepoSettingsRepo(db), ignoreStore := sqliteadapter.NewIgnoreRepo(db)
    2. Credential resolution: On startup, check credentialStore.Get(ctx, "github", "token") and credentialStore.Get(ctx, "github", "username"). If both are non-empty, use those. Otherwise fall back to cfg.GitHubToken/cfg.GitHubUsername. If neither source has credentials, ghClient is nil.
    3. Create GitHubClientProvider: provider := application.NewGitHubClientProvider(ghClient) (ghClient may be nil if no credentials).
    4. Modify PollService to accept *GitHubClientProvider instead of driven.GitHubClient. PollService.Start should call provider.Get() at the start of each poll cycle and skip polling if nil. Update NewPollService signature.
    5. Pass credentialStore, provider, and ignoreStore to the web handler (update NewHandler signature).
    6. Pass repoSettingsStore to web handler too (needed for Plan 04 but add the field now to avoid a second signature change).

    **GitHub adapter (mapPullRequest in pullrequests.go):**
    - Map NodeID from go-github's PullRequest.GetNodeID() to model.PullRequest.NodeID in the mapPullRequest function.

    **PollService changes:**
    - Change ghClient field type from driven.GitHubClient to *GitHubClientProvider
    - In pollAll and related methods, call s.ghClient.Get() to get current client; if nil, log info "no GitHub credentials configured, skipping poll" and return nil
    - Update NewPollService constructor

    **Web handler credential endpoints:**
    Add two new handler methods to handler.go:
    - `GetCredentialForm(w, r)`: Renders the credential form partial. Load current credentials via credentialStore.GetAll(ctx, "github") to pre-fill form fields (mask token to last 4 chars for display).
    - `SaveCredentials(w, r)`: ParseForm, validate CSRF, extract token + username from form. Save via credentialStore.Set for each. Create new GitHub client: githubadapter.NewClient(token, username). Call provider.Replace(newClient). Return credential_status partial showing success via HTMX OOB swap.

    **Add an exported NewClient function or use existing:** The github adapter's NewClient(token, username) is already public -- use it directly from the web handler. Import the github adapter package in the web handler (this is acceptable since the web handler is a driving adapter doing composition-like work for credential swap).

    **Register new routes in routes.go:**
    ```
    GET  /app/credentials  -> h.GetCredentialForm
    POST /app/credentials  -> h.SaveCredentials
    ```

    **Credential form template (credential_form.templ):**
    Create an HTMX form that POST to /app/credentials. Fields: GitHub Username (text input), GitHub Token (password input, pre-filled with masked value if exists). Submit button. hx-target="#credential-status" for response. Include CSRF hidden field using the existing csrf pattern. Use Alpine x-data for form state if needed.

    **Credential status partial (credential_status.templ):**
    Shows "Credentials configured" (green) or "No credentials configured" (amber) with an edit button that loads the form via hx-get="/app/credentials".

    **View model additions:**
    Add CredentialStatusViewModel (Configured bool, Username string, TokenMasked string) to viewmodel package.

    **Dashboard integration:**
    Add a credential status indicator somewhere visible on the dashboard (e.g., in the sidebar header or a settings area). When no credentials are configured, show a prominent "Configure GitHub Credentials" call-to-action.
  </action>
  <verify>`go build ./...` compiles. `go test ./...` passes. Start the app without MYGITPANEL_GITHUB_TOKEN and verify it starts without crashing. Navigate to / and verify credential form appears. Note: full GitHub API testing requires real credentials.</verify>
  <done>Composition root wires all new stores and GitHubClientProvider. Credential form saves to SQLite and hot-swaps the GitHub client. PollService uses provider.Get() per cycle. App starts with or without env var credentials.</done>
</task>

<task type="auto">
  <name>Task 2: Review submission, comment reply, and draft toggle UI</name>
  <files>
    internal/adapter/driving/web/handler.go
    internal/adapter/driving/web/routes.go
    internal/adapter/driving/web/templates/components/review_form.templ
    internal/adapter/driving/web/templates/components/comment_reply.templ
    internal/adapter/driving/web/templates/components/draft_toggle.templ
    internal/adapter/driving/web/templates/partials/pr_detail_content.templ
    internal/adapter/driving/web/viewmodel/viewmodel.go
  </files>
  <action>
    **Web handler methods (handler.go):**

    1. `SubmitReview(w, r)`: ParseForm, validate CSRF. Extract "event" (APPROVE/REQUEST_CHANGES/COMMENT) and "body" from form. Get GitHub client from provider.Get(). Call client.CreateReview(ctx, repoFullName, prNumber, event, body). On success, re-render the PR detail content partial (re-fetch PR data to show updated state). On error, return 500 with error message.

    2. `AddComment(w, r)`: ParseForm, validate CSRF. Extract "body" from form. Call client.CreateIssueComment(ctx, repoFullName, prNumber, body). Re-render PR detail content on success.

    3. `ReplyToComment(w, r)`: ParseForm, validate CSRF. Extract "body" and comment ID from URL path. Call client.ReplyToReviewComment(ctx, repoFullName, prNumber, commentID, body). Re-render PR detail content on success.

    4. `ToggleDraft(w, r)`: ParseForm, validate CSRF. Get PR from store to read current IsDraft and NodeID. Call client.SetDraftStatus(ctx, repoFullName, prNumber, nodeID, !pr.IsDraft). Trigger a RefreshPR on pollSvc to update stored state. Re-render PR detail content.

    For all write handlers: if provider.Get() returns nil, return 403 with "GitHub credentials not configured" message.

    **Register new routes in routes.go:**
    ```
    POST /app/prs/{owner}/{repo}/{number}/review           -> h.SubmitReview
    POST /app/prs/{owner}/{repo}/{number}/comment           -> h.AddComment
    POST /app/prs/{owner}/{repo}/{number}/comments/{id}/reply -> h.ReplyToComment
    POST /app/prs/{owner}/{repo}/{number}/draft             -> h.ToggleDraft
    ```

    **Review form template (review_form.templ):**
    Follow the research example exactly. HTMX form POSTing to /app/prs/{owner}/{repo}/{number}/review. Alpine x-data for event radio state and body textarea. Three radio options: Comment (default), Approve, Request Changes. Submit button. hx-target="#pr-detail-content" hx-swap="innerHTML". Include CSRF token. Only show this form if the PR author is NOT the current user (you cannot review your own PR).

    **Comment reply template (comment_reply.templ):**
    Inline reply form shown when user clicks "Reply" on a thread. Alpine x-show toggle. HTMX form POSTing to the reply endpoint. Single textarea + submit button. hx-target="#pr-detail-content" hx-swap="innerHTML". Include CSRF token. Important: always pass the ROOT comment ID for the thread, not a nested reply ID (GitHub API limitation per research).

    **Draft toggle template (draft_toggle.templ):**
    A button/form that shows "Mark as Ready" if PR is draft, or "Convert to Draft" if PR is active. HTMX POST to /app/prs/{owner}/{repo}/{number}/draft. hx-target="#pr-detail-content" hx-swap="innerHTML". Include CSRF token. Show NodeID presence check -- if NodeID is empty, disable button with tooltip "Node ID not available, try refreshing PR data".

    **PR detail content integration (pr_detail_content.templ):**
    Add the review form below the existing conversation/threads section. Add draft toggle button near the PR title/status area. Add reply buttons on each thread root comment. Wire up the comment_reply inline form.

    **View model additions:**
    Add to PRDetailViewModel: CanReview bool (true if PR author != current username and credentials configured), CanToggleDraft bool (true if NodeID is non-empty and credentials configured), IsCurrentUser bool. Add RepoFullName, PRNumber as separate fields (needed for form action URLs if not already present).
  </action>
  <verify>`go build ./...` compiles after running `templ generate`. `go test ./...` passes. Start the app and navigate to a PR detail -- verify review form, draft toggle button, and reply buttons render (functional testing requires real GitHub credentials).</verify>
  <done>Review form with approve/request-changes/comment options renders on PR detail. Comment reply inline forms appear on thread root comments. Draft toggle button shows correct label based on PR state. All forms POST to correct endpoints with CSRF. Write handlers call GitHub API via provider.</done>
</task>

</tasks>

<verification>
- `templ generate` runs without errors
- `go build ./...` compiles
- `go test ./...` passes
- App starts without GitHub env vars and shows credential setup prompt
- App starts with GitHub env vars and works as before (backward compatible)
- PR detail view shows review form, reply buttons, and draft toggle
- Credential form renders and accepts input
</verification>

<success_criteria>
- Credential form saves to SQLite and hot-swaps GitHub client (CRED-01, CRED-02)
- Review submission form with 3 event types sends to GitHub API (REV-03)
- Comment reply form targets root comment ID (REV-02)
- Draft toggle uses GraphQL mutation with NodeID (REV-04)
- All write endpoints validate CSRF and check for configured credentials
- PollService uses hot-swapped client on next cycle
</success_criteria>

<output>
After completion, create `.planning/phases/08-review-workflows-and-attention-signals/08-03-SUMMARY.md`
</output>
