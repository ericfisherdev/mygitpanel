---
phase: 08-review-workflows-and-attention-signals
plan: 03
type: execute
wave: 3
depends_on: [08-01, 08-02]
files_modified:
  - internal/adapter/driven/github/writer.go
  - internal/adapter/driving/web/handler.go
  - internal/adapter/driving/web/routes.go
  - internal/adapter/driving/web/viewmodel.go
  - internal/adapter/driving/web/viewmodel/viewmodel.go
  - internal/adapter/driving/web/templates/components/pr_detail.templ
  - internal/adapter/driving/web/templates/components/review_thread.templ
  - internal/adapter/driving/web/templates/partials/pr_reviews_section.templ
autonomous: true
requirements: [REV-01, REV-02, REV-03]

must_haves:
  truths:
    - "PR detail panel shows existing review comments in threaded layout (root + replies indented below)"
    - "Each thread has a collapsed 'Reply' button that expands an inline textarea on click"
    - "User can type a reply and submit it; the thread section updates without a full page reload"
    - "User can submit a full review (approve / request changes / comment) from the PR detail panel"
    - "Review submit form accumulates staged line comments in Alpine state before submit"
    - "After review submit, the reviews section morphs to reflect the new review (HTMX morph swap)"
    - "If the user has no GitHub token configured, attempting to reply or submit review shows an error directing them to the settings drawer"
  artifacts:
    - path: "internal/adapter/driven/github/writer.go"
      provides: "SubmitReview, CreateReplyComment, CreateIssueComment fully implemented"
      contains: "func (c *Client) SubmitReview"
    - path: "internal/adapter/driving/web/templates/components/review_thread.templ"
      provides: "Thread rendering with inline reply box collapse/expand"
      contains: "review_thread"
    - path: "internal/adapter/driving/web/templates/partials/pr_reviews_section.templ"
      provides: "Full reviews section partial (threads + review submit form) for morph swap"
      contains: "pr_reviews_section"
    - path: "internal/adapter/driving/web/handler.go"
      provides: "SubmitReview, CreateReplyComment, CreateIssueComment handlers"
      contains: "SubmitReview"
  key_links:
    - from: "internal/adapter/driving/web/templates/components/review_thread.templ"
      to: "/app/prs/{owner}/{repo}/{number}/comments/{rootID}/reply"
      via: "hx-post on reply form; response morphs #thread-{rootID}"
      pattern: "hx-post.*comments.*reply"
    - from: "internal/adapter/driving/web/templates/partials/pr_reviews_section.templ"
      to: "/app/prs/{owner}/{repo}/{number}/review"
      via: "hx-post on review submit form; response morphs #pr-reviews-section"
      pattern: "hx-post.*review"
    - from: "internal/adapter/driving/web/handler.go"
      to: "internal/domain/port/driven/githubwriter.go"
      via: "h.ghWriter.SubmitReview and h.ghWriter.CreateReplyComment"
      pattern: "ghWriter\\.Submit|ghWriter\\.Create"
---

<objective>
Implement the full review workflow: threaded comment display with inline reply boxes, reply submission, and staged review submission (approve / request changes / comment) with optional line-level diff comments. GitHub write operations backed by real API calls.

Purpose: Delivers REV-01 (threaded view), REV-02 (reply), and REV-03 (submit review). This plan adds the write-side implementations to the GitHub adapter and the corresponding web handlers.

Output: Threaded review component with collapse/expand replies, review submit form with Alpine-managed pending comment staging, three fully implemented GitHubWriter methods, and the HTMX morph swap pattern for the reviews section.
</objective>

<execution_context>
@/home/ericfisher/.claude/get-shit-done/workflows/execute-plan.md
@/home/ericfisher/.claude/get-shit-done/templates/summary.md
<!-- Note: above paths are GSD tool paths under ~/.claude/get-shit-done/ — external to this repo -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-review-workflows-and-attention-signals/08-CONTEXT.md
@.planning/phases/08-review-workflows-and-attention-signals/08-RESEARCH.md
@.planning/phases/08-review-workflows-and-attention-signals/08-02-SUMMARY.md
@internal/adapter/driven/github/writer.go
@internal/adapter/driven/github/client.go
@internal/adapter/driving/web/handler.go
@internal/adapter/driving/web/routes.go
@internal/adapter/driving/web/viewmodel/viewmodel.go
@internal/adapter/driving/web/templates/components/pr_detail.templ
@internal/domain/port/driven/githubwriter.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SubmitReview, CreateReplyComment, CreateIssueComment in GitHub adapter</name>
  <files>
    internal/adapter/driven/github/writer.go
  </files>
  <action>
    Replace the three stubs in writer.go with real implementations.
    Retain ValidateToken unchanged. Keep ConvertPullRequestToDraft and
    MarkPullRequestReadyForReview as stubs (Plan 04).

    **SubmitReview:**
    Uses `c.gh.PullRequests.CreateReview(ctx, owner, repo, prNumber, &gh.PullRequestReviewRequest{...})`.
    Map driven.ReviewRequest → gh.PullRequestReviewRequest:
    - CommitID → CommitID (gh.Ptr)
    - Event → Event (gh.Ptr): pass through as-is ("APPROVE", "REQUEST_CHANGES", "COMMENT")
    - Body → Body (gh.Ptr); if empty string and Event == "APPROVE", omit Body (nil)
    - Comments → []*gh.DraftReviewComment: map each driven.DraftLineComment to a
      gh.DraftReviewComment with Line, Side, StartLine (omit if 0), Body set.
      Use the Line+Side fields (not the legacy Position field).
      If StartLine == 0: only set Line and Side. If StartLine > 0: also set StartLine and StartSide.
    On GitHub API error: wrap and return. The caller (web handler) surfaces the error.
    Note from research: `head_sha` race — re-fetch the PR head SHA immediately before
    submitting to get the current CommitID if the review request's CommitID is empty:
    fetch `c.gh.PullRequests.Get(ctx, owner, repo, prNumber)` and use `pr.GetHead().GetSHA()`.
    Surface 422 errors as: `fmt.Errorf("PR was updated since you started reviewing; refresh and try again: %w", err)`.

    **CreateReplyComment:**
    Uses `c.gh.PullRequests.CreateComment(ctx, owner, repo, prNumber, &gh.PullRequestComment{
        Body:        gh.Ptr(body),
        InReplyTo:   gh.Ptr(inReplyTo),
        CommitID:    gh.Ptr(commitSHA),
        Path:        gh.Ptr(path),
        SubjectType: gh.Ptr("line"),
    })`.
    Return wrapped error on failure.

    **CreateIssueComment:**
    Uses `c.gh.Issues.CreateComment(ctx, owner, repo, prNumber, &gh.IssueComment{Body: gh.Ptr(body)})`.
    Return wrapped error on failure.

    Compile-time check remains: `var _ driven.GitHubWriter = (*Client)(nil)`.
  </action>
  <verify>
    go build ./internal/adapter/driven/github/... succeeds
    go vet ./internal/adapter/driven/github/... passes
  </verify>
  <done>
    SubmitReview, CreateReplyComment, and CreateIssueComment are fully implemented
    against the GitHub REST API. ConvertToDraft and MarkReady remain as stubs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Review thread component, review submit form, reply and review handlers</name>
  <files>
    internal/adapter/driving/web/handler.go
    internal/adapter/driving/web/routes.go
    internal/adapter/driving/web/viewmodel.go
    internal/adapter/driving/web/viewmodel/viewmodel.go
    internal/adapter/driving/web/templates/components/pr_detail.templ
    internal/adapter/driving/web/templates/components/review_thread.templ
    internal/adapter/driving/web/templates/partials/pr_reviews_section.templ
  </files>
  <action>
    **internal/adapter/driving/web/templates/components/review_thread.templ:**
    Create a new templ component for rendering a single review thread (root comment +
    indented replies + inline reply box). Signature:
    `templ ReviewThread(thread viewmodel.ThreadViewModel, owner, repo string, prNumber int)`.

    Structure:
    - Outer div: id="thread-{thread.RootComment.ID}" x-data="{ replyOpen: false, replyBody: '' }"
    - Root comment: author, created_at, diff hunk (code block if non-empty), body text
    - Replies (if any): indented left with border-l-2, same fields
    - Reply button: `@click="replyOpen = !replyOpen"` text "Reply" / "Cancel"
    - Reply box (x-show="replyOpen", x-transition):
      hx-post="/app/prs/{owner}/{repo}/{prNumber}/comments/{thread.RootComment.ID}/reply"
      hx-target="#thread-{thread.RootComment.ID}"
      hx-swap="morph"
      @htmx:after-request.camel="replyOpen = false; replyBody = ''"
      Textarea: name="body", x-model="replyBody", rows="3"
      Hidden inputs: name="commit_sha" value="{pr headSHA}", name="path" value="{thread.RootComment.FilePath}"
      Submit button with hx-indicator pattern

    The component receives owner/repo/prNumber as strings/int for URL construction.
    Add these to the ThreadViewModel or pass as separate args — prefer separate args
    to keep the view model clean.

    **internal/adapter/driving/web/templates/partials/pr_reviews_section.templ:**
    A new partial that renders the complete reviews section:
    - All review threads via ReviewThread component
    - Issue comments section
    - "Submit Review" form (staged review with Alpine pending comment accumulation):
      x-data="{ pendingComments: [], reviewBody: '', reviewEvent: 'COMMENT' }"
      hx-post="/app/prs/{owner}/{repo}/{number}/review"
      hx-target="#pr-reviews-section"
      hx-swap="morph"
      x-init="$watch('pendingComments', value => { $refs.commentsInput.value = JSON.stringify(value) })"
      @htmx:after-request.camel="pendingComments = []; reviewBody = ''"
      <!-- Note: use x-init/$watch + x-ref to keep the hidden input in sync reactively.
           Do NOT use @submit.prevent + $el.submit() — that bypasses HTMX's hx-post interception. -->
      Fields:
      - textarea name="body" x-model="reviewBody"
      - select name="event": COMMENT (default), APPROVE, REQUEST_CHANGES
      - input[hidden] name="comments" x-ref="commentsInput" (kept in sync by x-init $watch above)
      - input[hidden] name="commit_sha" value="{pr.HeadSHA}"
      - Submit button
    - If pendingComments.length > 0: show list of pending comments with individual remove buttons

    This partial is the target for morph swaps on review/reply submit.
    Wrap the entire partial in: `<div id="pr-reviews-section">...</div>`.

    **internal/adapter/driving/web/templates/components/pr_detail.templ:**
    Replace the existing static reviews rendering in the "Reviews" tab with:
    `@partials.PRReviewsSection(pr, owner, repo)`.
    Pass owner, repo, prNumber to the partial. The section div must have id="pr-reviews-section".

    **internal/adapter/driving/web/viewmodel/viewmodel.go:**
    No new types needed — ThreadViewModel already exists from Phase 7. Verify it has
    RootComment.FilePath and that RootComment.CommitID is populated.

    **internal/adapter/driving/web/handler.go — add three handlers:**

    CreateReplyComment (POST /app/prs/{owner}/{repo}/{number}/comments/{rootID}/reply):
    - Extract owner, repo, number from path; rootID from path
    - Parse form: body, commit_sha, path
    - Validate: body non-empty
    - Authenticate: check credStore for github_token; if missing, return 422 with
      HTML fragment: `<p class="text-red-600 text-sm">Configure a GitHub token in Settings to reply to comments.</p>`
    - Call h.ghWriter.CreateReplyComment(ctx, repoFullName, prNumber, rootID, body, filePath, commitSHA)
    - On error: return 422 with error HTML fragment
    - On success: re-fetch full PR data and re-render the thread partial with morph swap
      targeting #thread-{rootID}

    SubmitReview (POST /app/prs/{owner}/{repo}/{number}/review):
    - Extract owner, repo, number from path
    - Parse form: body, event, comments (JSON array), commit_sha
    - JSON-decode comments into []driven.DraftLineComment (empty array is valid)
    - Validate event is one of APPROVE/REQUEST_CHANGES/COMMENT
    - Authenticate: check credStore for github_token; if missing, return 422 with error fragment
    - Build driven.ReviewRequest{CommitID: commitSHA, Event: event, Body: body, Comments: lineComments}
    - Call h.ghWriter.SubmitReview(ctx, repoFullName, prNumber, req)
    - On error: return 422 with error fragment (surface the 422 "PR updated" message clearly)
    - On success: re-fetch all PR reviews/comments and re-render pr_reviews_section partial
      targeting #pr-reviews-section with morph swap

    CreateIssueComment (POST /app/prs/{owner}/{repo}/{number}/issue-comments):
    - Parse form: body (non-empty validation)
    - Authenticate: check credStore
    - Call h.ghWriter.CreateIssueComment
    - On success: re-render pr_reviews_section with morph swap

    **internal/adapter/driving/web/routes.go:**
    ```go
    mux.HandleFunc("POST /app/prs/{owner}/{repo}/{number}/comments/{rootID}/reply", h.CreateReplyComment)
    mux.HandleFunc("POST /app/prs/{owner}/{repo}/{number}/review", h.SubmitReview)
    mux.HandleFunc("POST /app/prs/{owner}/{repo}/{number}/issue-comments", h.CreateIssueComment)
    ```

    Run `templ generate` after all .templ changes.
  </action>
  <verify>
    templ generate succeeds
    go build ./... succeeds
    go test ./... passes
    Manual: open PR detail, threads display with root comment + indented replies
    Manual: click Reply on a thread — inline textarea expands
    Manual: submit reply — thread section morphs showing new reply; textarea collapses
    Manual: fill review body, select APPROVE, submit — reviews section morphs
    Manual: attempt reply without GitHub token configured — error message shown inline
  </verify>
  <done>
    REV-01: Threaded comment layout renders in PR detail panel.
    REV-02: Reply box collapses/expands per thread; reply submits and section morphs.
    REV-03: Review submit form with event selector; staged pending line comments in Alpine state; morph swap on submit.
  </done>
</task>

</tasks>

<verification>
1. go build ./... succeeds
2. go test ./... passes
3. templ generate succeeds
4. PR detail shows threads with root + replies (indented)
5. Reply box expands on click, collapses after submit
6. Review form submits all three event types without error (requires valid GitHub token)
7. Review section morphs after submit (no full page reload)
8. Missing token shows actionable error fragment, not a 500
</verification>

<success_criteria>
- REV-01: PR comments displayed in threaded layout (root + replies)
- REV-02: Inline reply form per thread; submitted replies appear immediately via morph swap
- REV-03: Review submit form with APPROVE/REQUEST_CHANGES/COMMENT; pending line comments accumulated in Alpine state
- All GitHub API calls in writer.go are real (no stubs for these three methods)
</success_criteria>

<output>
After completion, create `.planning/phases/08-review-workflows-and-attention-signals/08-03-SUMMARY.md`
</output>
