---
phase: 08-review-workflows-and-attention-signals
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/domain/model/credential.go
  - internal/domain/model/threshold.go
  - internal/domain/model/attention.go
  - internal/domain/port/driven/credentialstore.go
  - internal/domain/port/driven/thresholdstore.go
  - internal/domain/port/driven/ignorestore.go
  - internal/domain/port/driven/githubwriter.go
  - internal/adapter/driven/sqlite/migrations/000010_add_credentials.up.sql
  - internal/adapter/driven/sqlite/migrations/000010_add_credentials.down.sql
  - internal/adapter/driven/sqlite/migrations/000011_add_thresholds.up.sql
  - internal/adapter/driven/sqlite/migrations/000011_add_thresholds.down.sql
  - internal/adapter/driven/sqlite/migrations/000012_add_ignored_prs.up.sql
  - internal/adapter/driven/sqlite/migrations/000012_add_ignored_prs.down.sql
  - internal/adapter/driven/sqlite/credentialrepo.go
  - internal/adapter/driven/sqlite/credentialrepo_test.go
  - internal/adapter/driven/sqlite/thresholdrepo.go
  - internal/adapter/driven/sqlite/thresholdrepo_test.go
  - internal/adapter/driven/sqlite/ignorerepo.go
  - internal/adapter/driven/sqlite/ignorerepo_test.go
  - internal/config/config.go
autonomous: true
requirements: [CRED-01, CRED-02, ATT-01, ATT-02, ATT-03, ATT-04]

must_haves:
  truths:
    - "Migrations 000010–000012 run cleanly against an existing v1 database without errors"
    - "CredentialRepo can store and retrieve an encrypted credential value via AES-256-GCM"
    - "ThresholdRepo can read global defaults and per-repo overrides, returning merged effective thresholds"
    - "IgnoreRepo can mark a PR ignored, list all ignored PR IDs, and un-ignore"
    - "Config loads MYGITPANEL_SECRET_KEY as optional; app starts without it with a warning"
    - "MYGITPANEL_GITHUB_TOKEN is demoted to optional in config (warns when absent, does not fail)"
    - "All new port interfaces are defined and compile-checked against their SQLite implementations"
  artifacts:
    - path: "internal/domain/model/credential.go"
      provides: "Credential model (service, value, updated_at)"
      contains: "type Credential struct"
    - path: "internal/domain/model/threshold.go"
      provides: "RepoThreshold and GlobalSettings models"
      contains: "type RepoThreshold struct"
    - path: "internal/domain/model/attention.go"
      provides: "AttentionSignals transient model and EffectiveThresholds"
      contains: "type AttentionSignals struct"
    - path: "internal/domain/port/driven/credentialstore.go"
      provides: "CredentialStore port interface"
      contains: "type CredentialStore interface"
    - path: "internal/domain/port/driven/thresholdstore.go"
      provides: "ThresholdStore port interface"
      contains: "type ThresholdStore interface"
    - path: "internal/domain/port/driven/ignorestore.go"
      provides: "IgnoreStore port interface (includes IgnoredPR type)"
      contains: "type IgnoreStore interface"
    - path: "internal/domain/port/driven/githubwriter.go"
      provides: "GitHubWriter port interface and ReviewRequest/DraftLineComment types"
      contains: "type GitHubWriter interface"
    - path: "internal/adapter/driven/sqlite/credentialrepo.go"
      provides: "CredentialRepo implementing CredentialStore with AES-256-GCM"
      exports: ["NewCredentialRepo", "ErrEncryptionKeyNotSet"]
    - path: "internal/adapter/driven/sqlite/thresholdrepo.go"
      provides: "ThresholdRepo implementing ThresholdStore"
      exports: ["NewThresholdRepo"]
    - path: "internal/adapter/driven/sqlite/ignorerepo.go"
      provides: "IgnoreRepo implementing IgnoreStore"
      exports: ["NewIgnoreRepo"]
  key_links:
    - from: "internal/adapter/driven/sqlite/credentialrepo.go"
      to: "internal/domain/port/driven/credentialstore.go"
      via: "compile-time check: var _ driven.CredentialStore = (*CredentialRepo)(nil)"
      pattern: "var _ driven\\.CredentialStore"
    - from: "internal/adapter/driven/sqlite/thresholdrepo.go"
      to: "internal/domain/port/driven/thresholdstore.go"
      via: "compile-time check: var _ driven.ThresholdStore = (*ThresholdRepo)(nil)"
      pattern: "var _ driven\\.ThresholdStore"
    - from: "internal/adapter/driven/sqlite/ignorerepo.go"
      to: "internal/domain/port/driven/ignorestore.go"
      via: "compile-time check: var _ driven.IgnoreStore = (*IgnoreRepo)(nil)"
      pattern: "var _ driven\\.IgnoreStore"
    - from: "internal/config/config.go"
      to: "MYGITPANEL_SECRET_KEY env var"
      via: "hex.DecodeString → cfg.SecretKey []byte (nil when absent)"
      pattern: "SecretKey"
---

<objective>
Establish the complete data foundation for Phase 8: domain models, port interfaces, SQLite migrations, and concrete repository implementations for credential storage (with AES-256-GCM encryption), attention threshold config, and the PR ignore list.

Purpose: All write operations and attention signals in Plans 02–05 depend on this foundation. No UI or handler code is included — this plan is purely the hexagonal inner layers plus data storage.

Output: Four new port interfaces, three new SQLite repositories (each with tests against a real in-memory DB), three migration pairs (000010–000012), updated config for MYGITPANEL_SECRET_KEY, and domain models for credentials, thresholds, attention signals, and the GitHubWriter port contract.
</objective>

<execution_context>
@/home/ericfisher/.claude/get-shit-done/workflows/execute-plan.md
@/home/ericfisher/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-review-workflows-and-attention-signals/08-CONTEXT.md
@.planning/phases/08-review-workflows-and-attention-signals/08-RESEARCH.md
@internal/domain/port/driven/prstore.go
@internal/domain/port/driven/githubclient.go
@internal/domain/model/pullrequest.go
@internal/adapter/driven/sqlite/db.go
@internal/adapter/driven/sqlite/prrepo.go
@internal/adapter/driven/sqlite/testhelper_test.go
@internal/config/config.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Domain models, port interfaces, and config changes</name>
  <files>
    internal/domain/model/credential.go
    internal/domain/model/threshold.go
    internal/domain/model/attention.go
    internal/domain/port/driven/credentialstore.go
    internal/domain/port/driven/thresholdstore.go
    internal/domain/port/driven/ignorestore.go
    internal/domain/port/driven/githubwriter.go
    internal/config/config.go
  </files>
  <action>
    Create seven new files and modify config.go.

    **internal/domain/model/credential.go:**
    Credential struct with fields: ID int64, Service string, Value string (plaintext at domain boundary — the SQLite adapter encrypts/decrypts), UpdatedAt time.Time.

    **internal/domain/model/threshold.go:**
    Two structs:
    - GlobalSettings: ReviewCountThreshold int, AgeUrgencyDays int, StaleReviewEnabled bool, CIFailureEnabled bool.
    - RepoThreshold: RepoFullName string, ReviewCount *int (nil = use global), AgeUrgencyDays *int, StaleReviewEnabled *bool, CIFailureEnabled *bool.
    - DefaultGlobalSettings() function returning GlobalSettings{ReviewCountThreshold:1, AgeUrgencyDays:7, StaleReviewEnabled:true, CIFailureEnabled:true}.

    **internal/domain/model/attention.go:**
    Two structs:
    - EffectiveThresholds: ReviewCountThreshold int, AgeUrgencyDays int, StaleReviewEnabled bool, CIFailureEnabled bool. (Merged result of global + per-repo override.)
    - AttentionSignals: NeedsMoreReviews bool, IsAgeUrgent bool, HasStaleReview bool, HasCIFailure bool.
    - HasAny() bool method on AttentionSignals.
    - Severity() int method returning count of active signals (0–4), used for border color in the UI.

    **internal/domain/port/driven/credentialstore.go:**
    CredentialStore interface with methods:
    - Set(ctx, service, plaintext string) error
    - Get(ctx, service string) (string, error) — returns ("", nil) if not found
    - List(ctx) ([]model.Credential, error)
    - Delete(ctx, service string) error

    **internal/domain/port/driven/thresholdstore.go:**
    ThresholdStore interface with methods:
    - GetGlobalSettings(ctx) (model.GlobalSettings, error)
    - SetGlobalSettings(ctx, model.GlobalSettings) error
    - GetRepoThreshold(ctx, repoFullName string) (model.RepoThreshold, error) — returns zero-value (all nil pointers) when no override exists
    - SetRepoThreshold(ctx, model.RepoThreshold) error
    - DeleteRepoThreshold(ctx, repoFullName string) error

    **internal/domain/port/driven/ignorestore.go:**
    Define IgnoredPR struct (PRID int64, IgnoredAt time.Time) in this file (not in model/ — it is a port-layer concern). IgnoreStore interface with methods:
    - Ignore(ctx, prID int64) error — idempotent
    - Unignore(ctx, prID int64) error
    - IsIgnored(ctx, prID int64) (bool, error)
    - ListIgnored(ctx) ([]IgnoredPR, error) — ordered by ignored_at DESC
    - ListIgnoredIDs(ctx) (map[int64]struct{}, error) — for O(1) lookup in application layer

    **internal/domain/port/driven/githubwriter.go:**
    Define two input types in this file:
    - DraftLineComment: Path string, Line int, Side string ("RIGHT"/"LEFT"), StartLine int, StartSide string, Body string.
    - ReviewRequest: CommitID string, Event string ("APPROVE"/"REQUEST_CHANGES"/"COMMENT"), Body string, Comments []DraftLineComment.
    GitHubWriter interface with methods:
    - SubmitReview(ctx, repoFullName string, prNumber int, req ReviewRequest) error
    - CreateReplyComment(ctx, repoFullName string, prNumber int, inReplyTo int64, body, path, commitSHA string) error
    - CreateIssueComment(ctx, repoFullName string, prNumber int, body string) error
    - ConvertPullRequestToDraft(ctx, repoFullName string, prNumber int) error
    - MarkPullRequestReadyForReview(ctx, repoFullName string, prNumber int) error
    - ValidateToken(ctx, token string) (username string, err error)

    **internal/config/config.go changes:**
    1. Add SecretKey []byte field to Config struct.
    2. Change MYGITPANEL_GITHUB_TOKEN from required (error) to optional (warn): if absent, set cfg.GitHubToken = "" and log slog.Warn("MYGITPANEL_GITHUB_TOKEN not set — polling disabled until credentials configured via GUI or via the settings drawer").
    3. Add MYGITPANEL_SECRET_KEY loading after the token block:
       - If absent: cfg.SecretKey = nil, slog.Warn("MYGITPANEL_SECRET_KEY not set — credential storage disabled")
       - If present but not exactly 64 hex chars: return error "MYGITPANEL_SECRET_KEY must be a 64-character hex string (32 bytes)"
       - If valid: hex.DecodeString → cfg.SecretKey (import encoding/hex)
    4. MYGITPANEL_GITHUB_USERNAME remains required (unchanged).
    5. All existing fields and defaults unchanged.
  </action>
  <verify>
    go build ./internal/domain/... succeeds
    go build ./internal/config/... succeeds
    go vet ./internal/domain/... passes
    go vet ./internal/config/... passes
  </verify>
  <done>
    All domain models compile with no external dependencies. All four port interfaces
    compile. Config accepts absent MYGITPANEL_GITHUB_TOKEN and MYGITPANEL_SECRET_KEY
    without failing, logging warnings instead.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrations 000010–000012 and SQLite repo implementations with tests</name>
  <files>
    internal/adapter/driven/sqlite/migrations/000010_add_credentials.up.sql
    internal/adapter/driven/sqlite/migrations/000010_add_credentials.down.sql
    internal/adapter/driven/sqlite/migrations/000011_add_thresholds.up.sql
    internal/adapter/driven/sqlite/migrations/000011_add_thresholds.down.sql
    internal/adapter/driven/sqlite/migrations/000012_add_ignored_prs.up.sql
    internal/adapter/driven/sqlite/migrations/000012_add_ignored_prs.down.sql
    internal/adapter/driven/sqlite/credentialrepo.go
    internal/adapter/driven/sqlite/credentialrepo_test.go
    internal/adapter/driven/sqlite/thresholdrepo.go
    internal/adapter/driven/sqlite/thresholdrepo_test.go
    internal/adapter/driven/sqlite/ignorerepo.go
    internal/adapter/driven/sqlite/ignorerepo_test.go
  </files>
  <action>
    **Migration 000010_add_credentials.up.sql:**
    ```sql
    CREATE TABLE IF NOT EXISTS credentials (
        id         INTEGER PRIMARY KEY AUTOINCREMENT,
        service    TEXT    NOT NULL UNIQUE,
        value      TEXT    NOT NULL DEFAULT '',
        updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
    );
    ```
    Down: `DROP TABLE IF EXISTS credentials;`

    **Migration 000011_add_thresholds.up.sql:**
    ```sql
    CREATE TABLE IF NOT EXISTS global_settings (
        key   TEXT NOT NULL PRIMARY KEY,
        value TEXT NOT NULL DEFAULT ''
    );
    INSERT OR IGNORE INTO global_settings (key, value) VALUES
        ('review_count_threshold', '1'),
        ('age_urgency_days',       '7'),
        ('stale_review_enabled',   '1'),
        ('ci_failure_enabled',     '1');
    CREATE TABLE IF NOT EXISTS repo_thresholds (
        repo_full_name       TEXT    NOT NULL PRIMARY KEY,
        review_count         INTEGER,
        age_urgency_days     INTEGER,
        stale_review_enabled INTEGER,
        ci_failure_enabled   INTEGER,
        FOREIGN KEY (repo_full_name) REFERENCES repositories(full_name) ON DELETE CASCADE
    );
    ```
    Down: `DROP TABLE IF EXISTS repo_thresholds; DROP TABLE IF EXISTS global_settings;`

    **Migration 000012_add_ignored_prs.up.sql:**
    ```sql
    CREATE TABLE IF NOT EXISTS ignored_prs (
        pr_id      INTEGER NOT NULL PRIMARY KEY,
        ignored_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (pr_id) REFERENCES pull_requests(id) ON DELETE CASCADE
    );
    ```
    Down: `DROP TABLE IF EXISTS ignored_prs;`

    **credentialrepo.go:**
    Package-level sentinel: `var ErrEncryptionKeyNotSet = errors.New("encryption key not configured: set MYGITPANEL_SECRET_KEY")`.
    Compile-time check: `var _ driven.CredentialStore = (*CredentialRepo)(nil)`.
    Constructor: `NewCredentialRepo(db *DB, key []byte) *CredentialRepo`.
    Private encrypt/decrypt helpers using AES-256-GCM from 08-RESEARCH.md Section 2.2:
    nonce (12 bytes) prepended to ciphertext, full blob base64-encoded.
    Both return ErrEncryptionKeyNotSet if key is nil.
    Set uses `INSERT OR REPLACE INTO credentials (service, value, updated_at) VALUES (?, ?, CURRENT_TIMESTAMP)` on db.Writer.
    Get queries db.Reader, decrypts, returns ("", nil) when sql.ErrNoRows.
    List queries db.Reader for all rows, decrypts each.
    Delete deletes by service on db.Writer.

    **thresholdrepo.go:**
    Compile-time check: `var _ driven.ThresholdStore = (*ThresholdRepo)(nil)`.
    Constructor: `NewThresholdRepo(db *DB) *ThresholdRepo`.
    GetGlobalSettings reads 4 rows from global_settings. Parse 'review_count_threshold' and 'age_urgency_days' with strconv.Atoi. Parse 'stale_review_enabled' and 'ci_failure_enabled' as "1"/"0". If any row is missing, use the DefaultGlobalSettings() value for that field. If the table is completely empty, return model.DefaultGlobalSettings().
    SetGlobalSettings runs inside a transaction: upsert each of the four keys with `INSERT OR REPLACE INTO global_settings (key, value) VALUES (?, ?)`.
    GetRepoThreshold queries repo_thresholds by repo_full_name. Scan nullable integer fields (review_count, age_urgency_days) using sql.NullInt64; if Valid, convert to *int. Scan nullable boolean fields (stale_review_enabled, ci_failure_enabled) using sql.NullInt64 (SQLite stores booleans as INTEGER); if Valid, convert 0/1 to *bool. Return zero-value RepoThreshold with all nil pointers on sql.ErrNoRows.
    SetRepoThreshold uses `INSERT OR REPLACE INTO repo_thresholds`.
    DeleteRepoThreshold deletes by repo_full_name.

    **ignorerepo.go:**
    Compile-time check: `var _ driven.IgnoreStore = (*IgnoreRepo)(nil)`.
    Constructor: `NewIgnoreRepo(db *DB) *IgnoreRepo`.
    Ignore: `INSERT OR IGNORE INTO ignored_prs (pr_id) VALUES (?)` on db.Writer.
    Unignore: `DELETE FROM ignored_prs WHERE pr_id = ?` on db.Writer.
    IsIgnored: `SELECT COUNT(*) FROM ignored_prs WHERE pr_id = ?` on db.Reader; return count > 0.
    ListIgnored: `SELECT pr_id, ignored_at FROM ignored_prs ORDER BY ignored_at DESC` on db.Reader.
    ListIgnoredIDs: same query but build map[int64]struct{}.

    **Test files:**
    Each test file uses testhelper_test.go's newTestDB() helper (or equivalent). Follow the existing table-driven test pattern from prrepo_test.go.

    credentialrepo_test.go must cover:
    - Set + Get round-trips plaintext (use a 32-byte test key: make([]byte, 32))
    - Get on unknown service returns ("", nil)
    - Set twice overwrites and returns updated value
    - List returns all stored credentials
    - Delete removes record; Get returns ("", nil) after delete
    - Set with nil key returns ErrEncryptionKeyNotSet
    - Get with nil key returns ErrEncryptionKeyNotSet

    thresholdrepo_test.go must cover:
    - GetGlobalSettings returns values matching DefaultGlobalSettings() after migration pre-seeds global_settings (migration INSERT OR IGNORE ensures the table is never empty after startup)
    - SetGlobalSettings + GetGlobalSettings round-trips all four fields
    - GetRepoThreshold returns zero-value (all nil) when no row exists
    - SetRepoThreshold persists; GetRepoThreshold returns correct override values
    - SetRepoThreshold with nil pointer fields stores NULL; GetRepoThreshold returns nil
    - DeleteRepoThreshold removes the row

    ignorerepo_test.go must cover:
    - Ignore + IsIgnored returns true
    - Unignore + IsIgnored returns false
    - Double Ignore is idempotent (no error)
    - ListIgnored returns records ordered by ignored_at DESC
    - ListIgnoredIDs returns correct set
    - Unignore on non-existent ID is a no-op (no error)
  </action>
  <verify>
    go test ./internal/adapter/driven/sqlite/... -v -run TestCredential passes
    go test ./internal/adapter/driven/sqlite/... -v -run TestThreshold passes
    go test ./internal/adapter/driven/sqlite/... -v -run TestIgnore passes
    go test ./internal/adapter/driven/sqlite/... passes (all tests, including existing ones)
    go build ./... succeeds
  </verify>
  <done>
    All six migration SQL files exist with valid syntax. Three new repos each have a
    compile-time interface check, a constructor, and full test coverage. Existing
    sqlite test suite is unaffected.
  </done>
</task>

</tasks>

<verification>
1. go build ./... succeeds
2. go test ./internal/adapter/driven/sqlite/... — all tests pass including new ones
3. go vet ./... — no issues
4. Six migration files (000010–000012 up/down) present in migrations/ directory
5. Compile-time interface checks present in all three new repo files
6. Config: app starts without MYGITPANEL_GITHUB_TOKEN (warns, does not error)
7. Config: app errors if MYGITPANEL_SECRET_KEY is present but malformed (not 64 hex chars)
8. Config: app starts without MYGITPANEL_SECRET_KEY (warns, SecretKey = nil)
</verification>

<success_criteria>
- Four new port interfaces compile cleanly with no external dependencies
- Three SQLite repositories each pass their test suite against a real in-memory DB
- AES-256-GCM encryption: nil key returns ErrEncryptionKeyNotSet rather than panicking
- Migrations 000010–000012 run against existing schema without errors
- MYGITPANEL_GITHUB_TOKEN optional in config; MYGITPANEL_SECRET_KEY optional (nil disables credential storage)
</success_criteria>

<output>
After completion, create `.planning/phases/08-review-workflows-and-attention-signals/08-01-SUMMARY.md`
</output>
