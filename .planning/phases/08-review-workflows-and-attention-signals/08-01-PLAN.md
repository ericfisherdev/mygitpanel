---
phase: 08-review-workflows-and-attention-signals
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/domain/model/credential.go
  - internal/domain/model/reposettings.go
  - internal/domain/model/ignoredpr.go
  - internal/domain/model/pullrequest.go
  - internal/domain/port/driven/credentialstore.go
  - internal/domain/port/driven/reposettingsstore.go
  - internal/domain/port/driven/ignorestore.go
  - internal/adapter/driven/sqlite/credentialrepo.go
  - internal/adapter/driven/sqlite/credentialrepo_test.go
  - internal/adapter/driven/sqlite/reposettingsrepo.go
  - internal/adapter/driven/sqlite/reposettingsrepo_test.go
  - internal/adapter/driven/sqlite/ignorerepo.go
  - internal/adapter/driven/sqlite/ignorerepo_test.go
  - internal/adapter/driven/sqlite/prrepo.go
  - internal/adapter/driven/sqlite/migrations/000010_add_credentials.up.sql
  - internal/adapter/driven/sqlite/migrations/000010_add_credentials.down.sql
  - internal/adapter/driven/sqlite/migrations/000011_add_repo_settings.up.sql
  - internal/adapter/driven/sqlite/migrations/000011_add_repo_settings.down.sql
  - internal/adapter/driven/sqlite/migrations/000012_add_ignored_prs.up.sql
  - internal/adapter/driven/sqlite/migrations/000012_add_ignored_prs.down.sql
  - internal/adapter/driven/sqlite/migrations/000013_add_node_id.up.sql
  - internal/adapter/driven/sqlite/migrations/000013_add_node_id.down.sql
autonomous: true

must_haves:
  truths:
    - "Credential, RepoSettings, and IgnoredPR domain entities exist with zero external dependencies"
    - "Three new port interfaces (CredentialStore, RepoSettingsStore, IgnoreStore) define driven contracts"
    - "SQLite adapters implement all three new ports with full CRUD"
    - "PullRequest model has NodeID field persisted via migration and populated in PR repo"
    - "All new migrations run without errors on existing databases"
  artifacts:
    - path: "internal/domain/model/credential.go"
      provides: "Credential entity"
      contains: "type Credential struct"
    - path: "internal/domain/model/reposettings.go"
      provides: "RepoSettings entity"
      contains: "type RepoSettings struct"
    - path: "internal/domain/model/ignoredpr.go"
      provides: "IgnoredPR entity"
      contains: "type IgnoredPR struct"
    - path: "internal/domain/port/driven/credentialstore.go"
      provides: "CredentialStore port interface"
      exports: ["CredentialStore"]
    - path: "internal/domain/port/driven/reposettingsstore.go"
      provides: "RepoSettingsStore port interface"
      exports: ["RepoSettingsStore"]
    - path: "internal/domain/port/driven/ignorestore.go"
      provides: "IgnoreStore port interface"
      exports: ["IgnoreStore"]
    - path: "internal/adapter/driven/sqlite/credentialrepo.go"
      provides: "CredentialStore SQLite adapter"
      contains: "var _ driven.CredentialStore"
    - path: "internal/adapter/driven/sqlite/reposettingsrepo.go"
      provides: "RepoSettingsStore SQLite adapter"
      contains: "var _ driven.RepoSettingsStore"
    - path: "internal/adapter/driven/sqlite/ignorerepo.go"
      provides: "IgnoreStore SQLite adapter"
      contains: "var _ driven.IgnoreStore"
  key_links:
    - from: "internal/adapter/driven/sqlite/credentialrepo.go"
      to: "internal/domain/port/driven/credentialstore.go"
      via: "compile-time interface check"
      pattern: "var _ driven\\.CredentialStore"
    - from: "internal/adapter/driven/sqlite/prrepo.go"
      to: "internal/domain/model/pullrequest.go"
      via: "NodeID field in Upsert and scan"
      pattern: "node_id"
---

<objective>
Create the data foundation for Phase 8: domain models, port interfaces, SQLite migrations, and adapter implementations for credentials, repo settings, ignored PRs, and PR node IDs.

Purpose: All Phase 8 features (credential management, review workflows, attention signals, ignore list) depend on these domain entities and persistence adapters. Building the data layer first enables parallel UI work in subsequent plans.

Output: 3 new domain models, 3 new port interfaces, 3 new SQLite adapters with tests, 4 new migrations, NodeID added to PullRequest model and PR repo.
</objective>

<execution_context>
@/home/esfisher/.claude/get-shit-done/workflows/execute-plan.md
@/home/esfisher/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-review-workflows-and-attention-signals/08-RESEARCH.md
@internal/domain/model/pullrequest.go
@internal/domain/model/botconfig.go
@internal/domain/port/driven/credentialstore.go
@internal/domain/port/driven/repostore.go
@internal/domain/port/driven/prstore.go
@internal/adapter/driven/sqlite/botconfigrepo.go
@internal/adapter/driven/sqlite/prrepo.go
@internal/adapter/driven/sqlite/testhelper_test.go
@internal/adapter/driven/sqlite/migrations/000009_add_check_runs.up.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Domain models, port interfaces, and migrations</name>
  <files>
    internal/domain/model/credential.go
    internal/domain/model/reposettings.go
    internal/domain/model/ignoredpr.go
    internal/domain/model/pullrequest.go
    internal/domain/port/driven/credentialstore.go
    internal/domain/port/driven/reposettingsstore.go
    internal/domain/port/driven/ignorestore.go
    internal/adapter/driven/sqlite/migrations/000010_add_credentials.up.sql
    internal/adapter/driven/sqlite/migrations/000010_add_credentials.down.sql
    internal/adapter/driven/sqlite/migrations/000011_add_repo_settings.up.sql
    internal/adapter/driven/sqlite/migrations/000011_add_repo_settings.down.sql
    internal/adapter/driven/sqlite/migrations/000012_add_ignored_prs.up.sql
    internal/adapter/driven/sqlite/migrations/000012_add_ignored_prs.down.sql
    internal/adapter/driven/sqlite/migrations/000013_add_node_id.up.sql
    internal/adapter/driven/sqlite/migrations/000013_add_node_id.down.sql
  </files>
  <action>
    Create three new domain model files following the existing model pattern (pure Go, stdlib time only, no external imports):

    1. `credential.go`: Credential struct with ID int64, Service string, Key string, Value string, UpdatedAt time.Time. Service is "github" or "jira" (future). Key is "token", "username", etc.

    2. `reposettings.go`: RepoSettings struct with RepoFullName string, RequiredReviewCount int, UrgencyDays int. These are per-repo attention thresholds.

    3. `ignoredpr.go`: IgnoredPR struct with ID int64, RepoFullName string, PRNumber int, IgnoredAt time.Time.

    Add `NodeID string` field to PullRequest struct in pullrequest.go, in the persisted fields section after HeadSHA. Add a comment: "NodeID is the GitHub GraphQL node ID; required for draft toggle mutations."

    Create three new port interface files following existing patterns (context.Context first param, domain types only):

    1. `credentialstore.go`: CredentialStore interface with Set(ctx, service, key, value string) error, Get(ctx, service, key string) (string, error), GetAll(ctx, service string) (map[string]string, error), Delete(ctx, service, key string) error.

    2. `reposettingsstore.go`: RepoSettingsStore interface with GetSettings(ctx, repoFullName string) (*model.RepoSettings, error), SetSettings(ctx, settings model.RepoSettings) error.

    3. `ignorestore.go`: IgnoreStore interface with Ignore(ctx, repoFullName string, prNumber int) error, Unignore(ctx, repoFullName string, prNumber int) error, IsIgnored(ctx, repoFullName string, prNumber int) (bool, error), ListIgnored(ctx) ([]model.IgnoredPR, error).

    Create 4 migration pairs (up + down) following the established naming convention (000010-000013):

    - 000010: credentials table (id autoincrement PK, service TEXT NOT NULL, key TEXT NOT NULL, value TEXT NOT NULL, updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, UNIQUE(service, key))
    - 000011: repo_settings table (repo_full_name TEXT NOT NULL PRIMARY KEY, required_review_count INTEGER NOT NULL DEFAULT 2, urgency_days INTEGER NOT NULL DEFAULT 7, FOREIGN KEY(repo_full_name) REFERENCES repositories(full_name) ON DELETE CASCADE)
    - 000012: ignored_prs table (id autoincrement PK, repo_full_name TEXT NOT NULL, pr_number INTEGER NOT NULL, ignored_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, UNIQUE(repo_full_name, pr_number))
    - 000013: ALTER TABLE pull_requests ADD COLUMN node_id TEXT NOT NULL DEFAULT ''

    Down migrations: DROP TABLE for 010-012, and for 013 create a new temp table without node_id, copy data, drop original, rename (SQLite does not support DROP COLUMN in all versions).
  </action>
  <verify>`go build ./internal/domain/...` compiles. Migration SQL files exist with correct numbering. `go vet ./internal/domain/...` passes.</verify>
  <done>3 domain models, 3 port interfaces, 4 migration pairs exist. PullRequest has NodeID field. All domain packages compile with zero external dependencies.</done>
</task>

<task type="auto">
  <name>Task 2: SQLite adapters with tests and PR repo NodeID integration</name>
  <files>
    internal/adapter/driven/sqlite/credentialrepo.go
    internal/adapter/driven/sqlite/credentialrepo_test.go
    internal/adapter/driven/sqlite/reposettingsrepo.go
    internal/adapter/driven/sqlite/reposettingsrepo_test.go
    internal/adapter/driven/sqlite/ignorerepo.go
    internal/adapter/driven/sqlite/ignorerepo_test.go
    internal/adapter/driven/sqlite/prrepo.go
  </files>
  <action>
    Create three new SQLite adapter files following the established pattern in botconfigrepo.go:

    1. `credentialrepo.go`: CredentialRepo struct with db *DB field. Constructor NewCredentialRepo(db *DB). Implements driven.CredentialStore. Compile-time check: var _ driven.CredentialStore = (*CredentialRepo)(nil).
       - Set: INSERT INTO credentials (service, key, value, updated_at) VALUES (?, ?, ?, ?) ON CONFLICT(service, key) DO UPDATE SET value=excluded.value, updated_at=excluded.updated_at
       - Get: SELECT value FROM credentials WHERE service=? AND key=?. Return empty string + nil for no rows (not an error).
       - GetAll: SELECT key, value FROM credentials WHERE service=?. Return empty map if no rows.
       - Delete: DELETE FROM credentials WHERE service=? AND key=?

    2. `reposettingsrepo.go`: RepoSettingsRepo struct with db *DB. Constructor NewRepoSettingsRepo(db *DB). Implements driven.RepoSettingsStore. Compile-time check.
       - GetSettings: SELECT * FROM repo_settings WHERE repo_full_name=?. Return nil, nil for no rows (use defaults in caller).
       - SetSettings: INSERT INTO repo_settings (...) VALUES (?, ?, ?) ON CONFLICT(repo_full_name) DO UPDATE SET required_review_count=excluded.required_review_count, urgency_days=excluded.urgency_days

    3. `ignorerepo.go`: IgnoreRepo struct with db *DB. Constructor NewIgnoreRepo(db *DB). Implements driven.IgnoreStore. Compile-time check.
       - Ignore: INSERT INTO ignored_prs (repo_full_name, pr_number, ignored_at) VALUES (?, ?, ?) ON CONFLICT DO NOTHING
       - Unignore: DELETE FROM ignored_prs WHERE repo_full_name=? AND pr_number=?
       - IsIgnored: SELECT COUNT(*) FROM ignored_prs WHERE repo_full_name=? AND pr_number=? (count > 0)
       - ListIgnored: SELECT * FROM ignored_prs ORDER BY ignored_at DESC

    Update `prrepo.go`:
    - Add node_id to Upsert INSERT and ON CONFLICT SET clauses
    - Add node_id to scanPR helper
    - Add node_id to all SELECT column lists (listAllQuery, getByNumberQuery, listNeedingReviewQuery, etc.)

    Create test files following the established pattern using setupTestDB(t) from testhelper_test.go:
    - credentialrepo_test.go: Test Set/Get/GetAll/Delete, test upsert overwrites, test Get returns empty for missing
    - reposettingsrepo_test.go: Test SetSettings/GetSettings, test upsert, test GetSettings returns nil for missing
    - ignorerepo_test.go: Test Ignore/Unignore/IsIgnored/ListIgnored, test double-ignore is idempotent

    Use Writer for mutations, Reader for queries (existing dual-connection pattern).
  </action>
  <verify>`go test ./internal/adapter/driven/sqlite/...` passes including all new tests. `go vet ./internal/adapter/driven/sqlite/...` passes.</verify>
  <done>3 new SQLite adapters pass compile-time interface checks. All adapter tests pass. PR repo Upsert and scan include node_id.</done>
</task>

</tasks>

<verification>
- `go build ./...` compiles the entire project
- `go test ./internal/domain/...` passes
- `go test ./internal/adapter/driven/sqlite/...` passes with new adapter tests
- `go vet ./...` has no issues
- New migration files numbered 000010-000013 with both up and down
</verification>

<success_criteria>
- All 3 domain models exist as pure Go structs
- All 3 port interfaces defined with correct method signatures
- All 3 SQLite adapters implement their ports (compile-time checks pass)
- All adapter tests pass
- PullRequest.NodeID field exists and is persisted
- Migrations 000010-000013 exist and run on existing DB schema
</success_criteria>

<output>
After completion, create `.planning/phases/08-review-workflows-and-attention-signals/08-01-SUMMARY.md`
</output>
