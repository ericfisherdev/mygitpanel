---
phase: 07-gui-foundation
plan: 03
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - internal/adapter/driving/web/handler.go
  - internal/adapter/driving/web/routes.go
  - internal/adapter/driving/web/templates/components/search_bar.templ
  - internal/adapter/driving/web/templates/components/theme_toggle.templ
  - internal/adapter/driving/web/templates/components/repo_manager.templ
  - internal/adapter/driving/web/templates/partials/pr_list.templ
  - internal/adapter/driving/web/templates/partials/repo_list.templ
  - internal/adapter/driving/web/templates/components/sidebar.templ
  - internal/adapter/driving/web/templates/pages/dashboard.templ
  - internal/adapter/driving/web/viewmodel.go
autonomous: true

must_haves:
  truths:
    - "User can type text in the search bar and the PR list filters without a full page reload, with a debounce delay"
    - "User can filter PRs by status (open/closed/merged) and by repo, with results updating in the sidebar"
    - "User can toggle between dark and light theme, and the preference persists across browser sessions"
    - "User can add a new repo via the GUI and the PR feed updates to include PRs from the new repo"
    - "User can remove a watched repo via the GUI and the PR feed updates to exclude its PRs"
    - "GSAP animations play on PR selection (detail panel content fades/slides in) and PR list updates"
  artifacts:
    - path: "internal/adapter/driving/web/templates/components/search_bar.templ"
      provides: "Search input with HTMX debounced search and status/repo filter dropdowns"
      contains: "hx-trigger"
    - path: "internal/adapter/driving/web/templates/components/theme_toggle.templ"
      provides: "Dark/light mode toggle button using Alpine.js persist"
      contains: "$store.theme"
    - path: "internal/adapter/driving/web/templates/components/repo_manager.templ"
      provides: "Add/remove repo form with HTMX submission"
      contains: "hx-post"
    - path: "internal/adapter/driving/web/templates/partials/repo_list.templ"
      provides: "Repo list partial for OOB swap after add/remove"
      contains: "RepoList"
    - path: "internal/adapter/driving/web/handler.go"
      provides: "SearchPRs and repo management handler methods"
      contains: "SearchPRs"
  key_links:
    - from: "internal/adapter/driving/web/templates/components/search_bar.templ"
      to: "/app/prs/search"
      via: "hx-get with hx-trigger delay:500ms for debounced search"
      pattern: "hx-get.*app/prs/search.*delay:500ms"
    - from: "internal/adapter/driving/web/templates/components/repo_manager.templ"
      to: "/app/repos"
      via: "hx-post for add, hx-delete for remove"
      pattern: "hx-post.*app/repos|hx-delete.*app/repos"
    - from: "internal/adapter/driving/web/templates/components/theme_toggle.templ"
      to: "Alpine.store('theme')"
      via: "@click toggling $store.theme.dark"
      pattern: "\\$store\\.theme\\.dark"
---

<objective>
Add search/filter, repo management, theme toggle, and GSAP animations to complete all Phase 7 GUI requirements.

Purpose: Deliver GUI-03 (search and filter), GUI-04 (dark/light theme), GUI-06 (GSAP animations), and GUI-07 (repo management) — the interactive features that make the dashboard a usable tool beyond read-only browsing.

Output: Fully interactive dashboard with search, filtering, theme persistence, repo management, and smooth transitions.
</objective>

<!-- execution_context: GSD workflow directives (personal AI tooling, not required for contributors) -->

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-gui-foundation/07-RESEARCH.md
@.planning/phases/07-gui-foundation/07-01-SUMMARY.md
@.planning/phases/07-gui-foundation/07-02-SUMMARY.md
@internal/adapter/driving/web/handler.go
@internal/adapter/driving/web/routes.go
@internal/adapter/driving/web/viewmodel.go
@internal/adapter/driving/web/templates/components/sidebar.templ
@internal/adapter/driving/web/templates/pages/dashboard.templ
@internal/adapter/driving/web/templates/partials/pr_list.templ
@internal/domain/port/driven/prstore.go
@internal/domain/port/driven/repostore.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Search bar, status/repo filters, and server-side search handler</name>
  <files>
    internal/adapter/driving/web/templates/components/search_bar.templ
    internal/adapter/driving/web/templates/partials/pr_list.templ
    internal/adapter/driving/web/handler.go
    internal/adapter/driving/web/routes.go
    internal/adapter/driving/web/viewmodel.go
    internal/adapter/driving/web/templates/components/sidebar.templ
  </files>
  <action>
    **1. Create `templates/components/search_bar.templ`** (package `components`):

    A search bar with text input and filter dropdowns. All elements trigger HTMX requests to update the PR list.

    - Text input: `name="q"`, `hx-get="/app/prs/search"`, `hx-trigger="input changed delay:500ms"`, `hx-target="#pr-list"`, `hx-swap="morph"`, `hx-ext="alpine-morph"`, `hx-include="[name='status'],[name='repo']"` (includes filter values)
    - Status filter: `<select name="status">` with options: All, Open, Closed, Merged. Same hx-get/target/swap attributes but `hx-trigger="change"`. `hx-include="[name='q'],[name='repo']"`
    - Repo filter: `<select name="repo">` with options dynamically populated. Takes `repos []string` parameter. Same HTMX attributes. `hx-include="[name='q'],[name='status']"`
    - All three controls must include each other's values via `hx-include` so the server receives the full filter state on any change.
    - Style: Tailwind compact inputs with dark mode variants. Search icon (SVG inline) inside the input.
    - Placeholder text: "Search PRs..."

    **2. Add `RepoFilterViewModel` to viewmodel.go:**
    ```go
    type RepoFilterViewModel struct {
        FullName string
        Selected bool
    }
    ```

    **3. Update sidebar.templ** to include the SearchBar component above the PR list.

    **4. Update `dashboard.templ`** to pass repo names to SearchBar.

    **5. Add `SearchPRs` handler method:**

    ```go
    func (h *Handler) SearchPRs(w http.ResponseWriter, r *http.Request) {
        query := r.URL.Query().Get("q")
        status := r.URL.Query().Get("status")
        repo := r.URL.Query().Get("repo")

        // Fetch all PRs, then filter in-memory:
        // 1. If status != "" and status != "all": filter by pr.Status == status
        // 2. If repo != "" and repo != "all": filter by pr.RepoFullName == repo
        // 3. If query != "": case-insensitive substring match on pr.Title, pr.Author, pr.RepoFullName, pr.Branch
        //
        // Convert filtered results to view models, render partials.PRList
    }
    ```

    The in-memory filtering approach is appropriate for the expected scale (dozens to low hundreds of PRs). Do NOT add new database query methods for this.

    **6. Register route:**
    ```go
    mux.HandleFunc("GET /app/prs/search", h.SearchPRs)
    ```

    **Important:** The search_bar.templ takes a `repos []string` param for the repo dropdown. The handler must pass the distinct repo names from the current PR set.
  </action>
  <verify>
    - `templ generate && go build ./...` succeeds
    - `go test ./...` passes
    - Typing in search bar triggers XHR to `/app/prs/search?q=...` after 500ms debounce
    - Changing status dropdown immediately filters the PR list
    - Changing repo dropdown filters to that repo's PRs only
    - Combining text search + status + repo filter works correctly
    - Empty search returns all PRs
    - No results shows "No pull requests found" message
  </verify>
  <done>
    Search and filter fully functional. Users can search by text and filter by status and repo, with all combinations working. PR list updates via HTMX without page reload.
  </done>
</task>

<task type="auto">
  <name>Task 2: Theme toggle, repo management, and GSAP animation verification</name>
  <files>
    internal/adapter/driving/web/templates/components/theme_toggle.templ
    internal/adapter/driving/web/templates/components/repo_manager.templ
    internal/adapter/driving/web/templates/partials/repo_list.templ
    internal/adapter/driving/web/handler.go
    internal/adapter/driving/web/routes.go
    internal/adapter/driving/web/viewmodel.go
    internal/adapter/driving/web/templates/components/sidebar.templ
    internal/adapter/driving/web/templates/pages/dashboard.templ
    internal/adapter/driving/web/static/js/animations.js
  </files>
  <action>
    **1. Create `templates/components/theme_toggle.templ`** (package `components`):

    A toggle button that switches between dark and light mode using Alpine.js store with persist.

    ```templ
    templ ThemeToggle() {
        <button
            type="button"
            @click="$store.theme.dark = !$store.theme.dark"
            class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
            aria-label="Toggle dark mode"
        >
            <!-- Sun icon (shown in dark mode) -->
            <svg x-show="$store.theme.dark" class="w-5 h-5 text-yellow-400" ...>...</svg>
            <!-- Moon icon (shown in light mode) -->
            <svg x-show="!$store.theme.dark" class="w-5 h-5 text-gray-600" ...>...</svg>
        </button>
    }
    ```

    Use simple SVG icons for sun and moon (heroicons style). The theme state is already wired in layout.templ's Alpine store from Plan 01 — this component just toggles `$store.theme.dark`.

    The `dark:` Tailwind variant classes throughout all components (added in Plan 02) will automatically respond to the class change on `<html>`.

    **2. Create `templates/components/repo_manager.templ`** (package `components`):

    A section in the sidebar (below PR list or in a collapsible panel) for managing watched repos.

    - **Add repo form:**
      - Input: `name="full_name"`, placeholder "owner/repo"
      - Submit button: "Add"
      - `hx-post="/app/repos"`, `hx-target="#repo-list"`, `hx-swap="morph"`, `hx-ext="alpine-morph"`
      - On success, the server response includes both the updated repo list AND an OOB swap for the PR list:
        ```html
        <div id="repo-list">...updated repo list...</div>
        <div id="pr-list" hx-swap-oob="morph">...updated PR feed...</div>
        ```
      - Also include OOB swap for repo filter dropdown in search bar

    - **Repo list** (rendered via `RepoList` partial):
      - Each repo shows: full name, remove button
      - Remove button: `hx-delete="/app/repos/{owner}/{repo}"`, `hx-target="#repo-list"`, `hx-swap="morph"`, `hx-ext="alpine-morph"`, `hx-confirm="Remove {fullName}?"`
      - Same OOB swap pattern for PR list and repo filter on remove

    Takes `repos []RepoViewModel` parameter.

    **3. Add `RepoViewModel` to viewmodel.go:**
    ```go
    type RepoViewModel struct {
        FullName   string
        Owner      string
        Name       string
        DeletePath string // computed: /app/repos/{owner}/{repo}
    }
    ```

    And conversion function `toRepoViewModels(repos []model.Repository) []RepoViewModel`.

    **4. Create `templates/partials/repo_list.templ`** (package `partials`):
    - Renders the list of watched repos with remove buttons
    - This is the target for OOB swaps after add/remove operations

    **5. Add handler methods:**

    **AddRepo:**
    ```go
    func (h *Handler) AddRepo(w http.ResponseWriter, r *http.Request) {
        // Parse form value "full_name"
        // Validate format (reuse isValidRepoName from httphandler or extract to shared util)
        // Call repoStore.Add
        // Trigger async refresh via pollSvc.RefreshRepo (same as httphandler)
        // Re-fetch repos and PRs
        // Render repo list partial + OOB PR list partial + OOB repo filter dropdown
    }
    ```

    **RemoveRepo:**
    ```go
    func (h *Handler) RemoveRepo(w http.ResponseWriter, r *http.Request) {
        // Parse owner/repo from path
        // Call repoStore.Remove
        // Re-fetch repos and PRs
        // Render repo list partial + OOB PR list partial + OOB repo filter dropdown
    }
    ```

    For OOB swaps, the response should include multiple divs:
    - Primary target content (repo list)
    - `<div id="pr-list" hx-swap-oob="morph">` with updated PR list
    - `<select id="repo-filter" hx-swap-oob="morph">` with updated repo options (if search bar uses an id on the select)

    **6. Register routes:**
    ```go
    mux.HandleFunc("POST /app/repos", h.AddRepo)
    mux.HandleFunc("DELETE /app/repos/{owner}/{repo}", h.RemoveRepo)
    ```

    **7. Update sidebar.templ and dashboard.templ:**
    - Add ThemeToggle to the sidebar header (next to "ReviewHub" title)
    - Add RepoManager section to the sidebar (below search bar, or in a separate collapsible section)
    - Pass repo data to dashboard -> sidebar -> repo_manager

    **8. Verify and refine `static/js/animations.js`:**

    Ensure GSAP animations trigger correctly:
    - PR detail swap: content fades in with stagger (already set up in Plan 01)
    - PR list swap: items slide in from left
    - Test that `htmx:afterSwap` fires with morph swaps. If not, try `htmx:afterSettle` as noted in research open questions.

    Add animation for tab switching if not already covered:
    ```javascript
    // Tab content animation (Alpine.js handles show/hide, GSAP adds polish)
    document.addEventListener('alpine:effect', function() {
        // This approach may not work — Alpine doesn't emit events for x-show changes.
        // Alternative: Use x-transition on the tab content divs in templ instead.
    });
    ```

    If GSAP+Alpine tab animation is too complex, use Alpine's built-in `x-transition` directives on tab content divs for GUI-06 compliance. GSAP is for HTMX-driven swaps; Alpine handles its own UI transitions.

    **Validation for repo name:** Extract `isValidRepoName` into a shared internal package (e.g., `internal/validate/`) OR duplicate the simple validation logic in the web handler. Duplication is acceptable here since it's a 10-line function — avoid creating a shared package for one function.
  </action>
  <verify>
    - `templ generate && go build ./...` succeeds
    - `go test ./...` passes
    - Theme toggle switches between dark and light mode
    - Refreshing the page preserves the theme choice (localStorage)
    - Adding a repo via the GUI form triggers async refresh and updates both repo list and PR feed
    - Removing a repo updates both repo list and PR feed
    - Invalid repo name shows validation error
    - GSAP animations play on PR detail load (fade/slide in)
    - GSAP animations play on PR list updates (items slide in)
    - All HTMX morph swaps preserve Alpine state (theme, sidebar collapse, tab selection)
  </verify>
  <done>
    All Phase 7 GUI requirements are met: theme toggle with persistence (GUI-04), repo management (GUI-07), GSAP animations (GUI-06), plus search/filter from Task 1 (GUI-03). The dashboard is a fully interactive single-page experience.
  </done>
</task>

</tasks>

<verification>
1. `templ generate && go build ./...` succeeds
2. `go test ./...` — all tests pass
3. Search: typing "fix" filters PR list to titles/branches containing "fix"
4. Filter: selecting "open" status shows only open PRs
5. Filter: selecting a specific repo shows only that repo's PRs
6. Combined: search "fix" + status "open" + repo "owner/repo" works
7. Theme: clicking toggle switches dark/light, refreshing preserves choice
8. Add repo: entering "owner/repo" and clicking Add updates repo list and PR feed
9. Remove repo: clicking remove button removes repo and its PRs from feed
10. Animations: PR detail content fades in when selecting a PR
11. Animations: PR list items animate in when list updates
12. Alpine state: theme, sidebar, tabs survive HTMX swaps
</verification>

<success_criteria>
- GUI-03: Search and filter PRs by text, status, and repo — results update without page reload
- GUI-04: Dark/light theme toggle with localStorage persistence
- GUI-06: GSAP animations on PR selection, list updates
- GUI-07: Add/remove watched repos through the GUI with PR feed updating
- All HTMX swaps use morph to preserve Alpine.js state
- All components have dark mode Tailwind variants
</success_criteria>

<output>
After completion, create `.planning/phases/07-gui-foundation/07-03-SUMMARY.md`
</output>
