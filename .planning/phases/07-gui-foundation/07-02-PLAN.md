---
phase: 07-gui-foundation
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - internal/adapter/driving/web/viewmodel.go
  - internal/adapter/driving/web/handler.go
  - internal/adapter/driving/web/routes.go
  - internal/adapter/driving/web/templates/components/pr_card.templ
  - internal/adapter/driving/web/templates/components/pr_detail.templ
  - internal/adapter/driving/web/templates/components/sidebar.templ
  - internal/adapter/driving/web/templates/partials/pr_list.templ
  - internal/adapter/driving/web/templates/partials/pr_detail_content.templ
  - internal/adapter/driving/web/templates/pages/dashboard.templ
autonomous: true

must_haves:
  truths:
    - "User can see a list of PRs from all watched repos in the sidebar with status badges for CI, review state, and merge readiness"
    - "User can click a PR in the sidebar to load its full detail in the main content area without a full page reload"
    - "PR detail shows title, description stub, branch info, author, reviewers, CI checks, diff stats, and review comments with code context"
    - "User can collapse and expand the sidebar PR list"
  artifacts:
    - path: "internal/adapter/driving/web/viewmodel.go"
      provides: "View model structs for PR cards and PR detail, with conversion functions from domain models"
      contains: "PRCardViewModel"
    - path: "internal/adapter/driving/web/templates/components/pr_card.templ"
      provides: "PR card component with status indicators"
      contains: "PRCard"
    - path: "internal/adapter/driving/web/templates/components/pr_detail.templ"
      provides: "PR detail panel with tabs for reviews, threads, checks"
      contains: "PRDetail"
    - path: "internal/adapter/driving/web/templates/components/sidebar.templ"
      provides: "Collapsible sidebar with Alpine.js x-data for collapse state"
      contains: "x-show"
    - path: "internal/adapter/driving/web/templates/partials/pr_list.templ"
      provides: "PR list partial for HTMX swap updates"
      contains: "PRList"
    - path: "internal/adapter/driving/web/templates/partials/pr_detail_content.templ"
      provides: "PR detail partial for HTMX swap into main panel"
      contains: "PRDetailContent"
  key_links:
    - from: "internal/adapter/driving/web/templates/components/pr_card.templ"
      to: "/app/prs/{owner}/{repo}/{number}"
      via: "hx-get attribute on card click"
      pattern: "hx-get.*app/prs"
    - from: "internal/adapter/driving/web/handler.go"
      to: "internal/domain/port/driven/prstore.go"
      via: "h.prStore.ListAll() and h.prStore.GetByNumber()"
      pattern: "prStore\\.ListAll|prStore\\.GetByNumber"
    - from: "internal/adapter/driving/web/handler.go"
      to: "internal/application/reviewservice.go"
      via: "h.reviewSvc.GetPRReviewSummary() for enriched PR detail"
      pattern: "reviewSvc\\.GetPRReviewSummary"
---

<objective>
Build the PR feed sidebar and PR detail panel — the two primary content areas of the dashboard. User can browse PRs across all repos and click to view full detail with reviews, CI checks, and code context.

Purpose: Deliver GUI-01 (unified PR feed), GUI-02 (PR detail), and GUI-05 (collapsible sidebar) — the core read-only dashboard experience that surfaces all existing API data in a web UI.

Output: Functional dashboard with clickable PR list in collapsible sidebar and rich PR detail panel loaded via HTMX.
</objective>

<execution_context>
@/home/esfisher/.claude/get-shit-done/workflows/execute-plan.md
@/home/esfisher/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-gui-foundation/07-RESEARCH.md
@.planning/phases/07-gui-foundation/07-01-SUMMARY.md
@internal/adapter/driving/http/response.go
@internal/domain/model/pullrequest.go
@internal/domain/model/enums.go
@internal/domain/model/review.go
@internal/domain/model/reviewcomment.go
@internal/domain/model/issuecomment.go
@internal/domain/model/checkstatus.go
@internal/domain/port/driven/prstore.go
@internal/domain/port/driven/repostore.go
@internal/application/reviewservice.go
@internal/application/healthservice.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create view models and domain-to-viewmodel conversion functions</name>
  <files>
    internal/adapter/driving/web/viewmodel.go
  </files>
  <action>
    Replace the minimal `PageData` from Plan 01 with comprehensive view model structs. View models are the ONLY types passed to templ components — never pass domain models directly to templates (anti-pattern from research).

    Define these view model structs:

    **PRCardViewModel** — for sidebar PR list items:
    - `Number int`, `Repository string` (full name like "owner/repo"), `Title string`, `Author string`
    - `Status string` (open/closed/merged), `IsDraft bool`, `NeedsReview bool`
    - `CIStatus string` (passing/failing/pending/unknown), `MergeableStatus string` (mergeable/conflicted/unknown)
    - `ReviewStatus string` — empty for list view, can be enriched later
    - `DaysSinceOpened int`, `DaysSinceLastActivity int`
    - `Labels []string`
    - `URL string` — GitHub URL for external link
    - `DetailPath string` — computed `/app/prs/{owner}/{repo}/{number}` for hx-get

    **PRDetailViewModel** — for the main detail panel:
    - All fields from PRCardViewModel plus:
    - `Branch string`, `BaseBranch string`, `HeadSHA string`
    - `Additions int`, `Deletions int`, `ChangedFiles int`
    - `Reviews []ReviewViewModel`
    - `Threads []ThreadViewModel`
    - `IssueComments []IssueCommentViewModel`
    - `CheckRuns []CheckRunViewModel`
    - `Suggestions []SuggestionViewModel`
    - `HasBotReview bool`, `HasCoderabbitReview bool`, `AwaitingCoderabbit bool`
    - `ResolvedThreads int`, `UnresolvedThreads int`

    **ReviewViewModel:**
    - `ID int64`, `Reviewer string`, `State string`, `Body string`
    - `CommitID string`, `SubmittedAt string` (formatted for display)
    - `IsBot bool`, `IsOutdated bool`, `IsNitpick bool`

    **ThreadViewModel:**
    - `RootComment ReviewCommentViewModel`
    - `Replies []ReviewCommentViewModel`
    - `IsResolved bool`, `CommentCount int`

    **ReviewCommentViewModel:**
    - `ID int64`, `Author string`, `Body string`
    - `FilePath string`, `Line int`, `StartLine int`
    - `DiffHunk string`, `CommitID string`
    - `IsOutdated bool`, `CreatedAt string`

    **IssueCommentViewModel:**
    - `ID int64`, `Author string`, `Body string`, `IsBot bool`, `CreatedAt string`

    **CheckRunViewModel:**
    - `ID int64`, `Name string`, `Status string`, `Conclusion string`
    - `IsRequired bool`, `DetailsURL string`

    **SuggestionViewModel:**
    - `CommentID int64`, `FilePath string`, `StartLine int`, `EndLine int`, `ProposedCode string`

    **Conversion functions** (unexported, used by handler):
    - `toPRCardViewModels(prs []model.PullRequest) []PRCardViewModel` — batch conversion for list
    - `toPRDetailViewModel(pr model.PullRequest, summary *application.PRReviewSummary, checkRuns []model.CheckRun, headSHA string, botUsernames []string) PRDetailViewModel` — full enrichment
    - Helper functions for nested conversions: `toReviewViewModels`, `toThreadViewModels`, `toCheckRunViewModels`, etc.

    The `DetailPath` field should be computed as `fmt.Sprintf("/app/prs/%s/%d", pr.RepoFullName, pr.Number)`.

    Follow the same time formatting pattern as httphandler: `time.UTC().Format(time.RFC3339)`.
  </action>
  <verify>
    - `go build ./...` succeeds
    - `go vet ./internal/adapter/driving/web/...` passes
    - All view model structs have no domain model imports in their field types
    - Conversion functions exist for all model -> viewmodel mappings
  </verify>
  <done>
    View model layer is complete: templ components have typed, presentation-ready data without coupling to domain models.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PR card, PR detail, sidebar templ components and wire handler routes</name>
  <files>
    internal/adapter/driving/web/templates/components/pr_card.templ
    internal/adapter/driving/web/templates/components/pr_detail.templ
    internal/adapter/driving/web/templates/components/sidebar.templ
    internal/adapter/driving/web/templates/partials/pr_list.templ
    internal/adapter/driving/web/templates/partials/pr_detail_content.templ
    internal/adapter/driving/web/templates/pages/dashboard.templ
    internal/adapter/driving/web/handler.go
    internal/adapter/driving/web/routes.go
  </files>
  <action>
    **Create templ components:**

    **1. `templates/components/pr_card.templ`** (package `components`):
    - Renders a clickable card for one PR in the sidebar list
    - Shows: title (truncated to ~50 chars), `#number`, repo name, author
    - Status badges: CI status (green/red/yellow/gray dot), review state indicator, draft badge if draft
    - `hx-get` pointing to `pr.DetailPath`, `hx-target="#pr-detail"`, `hx-swap="morph"`, `hx-ext="alpine-morph"`
    - Use Tailwind: `p-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 border-b border-gray-200 dark:border-gray-700`
    - CI status dot colors: passing=green-500, failing=red-500, pending=yellow-500, unknown=gray-400
    - NeedsReview indicator: orange badge "Review Requested"
    - Mergeable status: conflicted shows red "Conflicts" badge

    **2. `templates/components/sidebar.templ`** (package `components`):
    - Wraps the PR list with collapse/expand functionality
    - Uses Alpine.js `x-data="{ collapsed: false }"` on the aside element
    - Collapse button toggles `collapsed` via `@click="collapsed = !collapsed"`
    - When collapsed: aside width shrinks to ~16 (icon-only), PR list hidden via `x-show="!collapsed"`
    - Header: "ReviewHub" title + collapse button (chevron icon, rotates on collapse)
    - Contains a `<div id="pr-list">` that holds the PR card list (loaded via HTMX or initial render)
    - Transition: `x-transition` on the pr-list div for smooth collapse/expand

    **3. `templates/partials/pr_list.templ`** (package `partials`):
    - Takes `[]PRCardViewModel` and renders a list of `PRCard` components
    - This is the HTMX partial response (no layout wrapper) — swapped into `#pr-list`
    - If list is empty, show "No pull requests found" message

    **4. `templates/components/pr_detail.templ`** (package `components`):
    - Takes `PRDetailViewModel` and renders the full PR detail
    - Header: PR title, `#number`, repo name, author, status badges, external GitHub link
    - Info section: branch -> base_branch, head SHA (truncated to 7 chars), opened X days ago
    - Stats: +additions / -deletions, changed files count, mergeable status
    - Tab navigation using Alpine.js `x-data="{ tab: 'reviews' }"`:
      - **Reviews tab**: List of reviews with reviewer name, state badge (approved=green, changes_requested=red, commented=gray), body text, outdated/bot/nitpick badges
      - **Threads tab**: Code review threads with root comment showing file path, diff hunk (in monospace pre block), line number, comment body, replies indented. Resolved threads shown with green checkmark, unresolved with yellow indicator.
      - **Comments tab**: Issue-level comments (PR conversation) with author, body, bot badge
      - **CI tab**: Check runs list with name, status, conclusion, required badge, link to details URL
    - Tab switching: `@click="tab = 'reviews'"`, content shown with `x-show="tab === 'reviews'"`
    - Empty states for each tab when no data

    **5. `templates/partials/pr_detail_content.templ`** (package `partials`):
    - Wrapper partial that renders `PRDetail` component
    - This is the HTMX partial response swapped into `#pr-detail`

    **6. Update `templates/pages/dashboard.templ`** (package `pages`):
    - Replace placeholder content from Plan 01
    - Compose: `Sidebar` component (with initial PR list) + main area with `#pr-detail` div
    - Takes `[]PRCardViewModel` for initial PR list rendering
    - The `#pr-detail` starts with the "Select a PR" placeholder

    **Update handler.go:**

    Update `Dashboard` method to fetch PRs and pass to template:
    ```go
    func (h *Handler) Dashboard(w http.ResponseWriter, r *http.Request) {
        prs, err := h.prStore.ListAll(r.Context())
        if err != nil {
            h.logger.Error("failed to list PRs", "error", err)
            http.Error(w, "internal server error", http.StatusInternalServerError)
            return
        }
        cards := toPRCardViewModels(prs)
        component := pages.Dashboard(cards)
        layout := templates.Layout("ReviewHub", component)
        if err := layout.Render(r.Context(), w); err != nil {
            h.logger.Error("failed to render dashboard", "error", err)
        }
    }
    ```

    Add `GetPRDetail` handler method:
    ```go
    func (h *Handler) GetPRDetail(w http.ResponseWriter, r *http.Request) {
        owner := r.PathValue("owner")
        repo := r.PathValue("repo")
        numberStr := r.PathValue("number")
        // Parse number, fetch PR via prStore.GetByNumber, enrich with reviewSvc and healthSvc
        // Convert to PRDetailViewModel, render partials.PRDetailContent
        // Follow same enrichment pattern as httphandler.GetPR (non-fatal enrichment)
    }
    ```

    **Update routes.go:**

    Add the PR detail route:
    ```go
    mux.HandleFunc("GET /app/prs/{owner}/{repo}/{number}", h.GetPRDetail)
    ```

    **Important templ patterns:**
    - Import components across packages: `import "github.com/ericfisherdev/mygitpanel/internal/adapter/driving/web/templates/components"`
    - Use `@components.PRCard(card)` syntax to render child components
    - For conditional CSS classes in templ, use `if` statements with different class strings or use `templ.KV()` for toggling
    - Always use `hx-swap="morph"` with `hx-ext="alpine-morph"` on elements containing Alpine directives to prevent state destruction
  </action>
  <verify>
    - `templ generate` succeeds with no errors
    - `go build ./...` succeeds
    - `go test ./...` — all existing tests pass
    - Visiting `http://localhost:8080/` shows the sidebar with PR cards (if repos are watched)
    - Clicking a PR card loads detail in the main panel without page reload
    - Sidebar collapse/expand works
    - PR detail tabs (reviews, threads, comments, CI) switch without page reload
    - All HTMX requests return HTML fragments (not full pages)
  </verify>
  <done>
    The PR feed sidebar and PR detail panel are functional. Users can browse all PRs and view full detail including reviews, threads, CI checks, and code context. Sidebar collapses and expands. All interactions are HTMX-driven partial updates.
  </done>
</task>

</tasks>

<verification>
1. `templ generate && go build ./...` succeeds
2. `go test ./...` — all tests pass
3. Dashboard at `/` renders PR list in sidebar
4. Clicking PR card loads detail via HTMX (check Network tab: XHR request to `/app/prs/...`)
5. PR detail shows all tabs: reviews, threads, comments, CI
6. Tab switching works without page reload (Alpine.js)
7. Sidebar collapse/expand works (Alpine.js)
8. Dark mode classes present on all components (ready for theme toggle in Plan 03)
9. Status badges show correct colors for CI, review state, mergeable status
</verification>

<success_criteria>
- GUI-01: Unified PR feed visible in sidebar across all watched repos with status indicators
- GUI-02: PR detail panel shows description, branch info, reviewers, CI checks, diff stats, review comments with code context
- GUI-05: Sidebar collapses and expands
- All interactions use HTMX partial swaps (no full page reloads)
- View models cleanly separate domain from presentation
</success_criteria>

<output>
After completion, create `.planning/phases/07-gui-foundation/07-02-SUMMARY.md`
</output>
