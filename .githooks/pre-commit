#!/bin/bash
set -e

echo "=== Pre-commit checks (mirrors CI pipeline) ==="

# 1. Lint - same as CI Lint job
echo ""
echo ">>> [1/5] Lint"

echo "    Running go fmt..."
fmt_output=$(gofmt -l .)
if [ -n "$fmt_output" ]; then
    echo "    ERROR: The following files are not formatted:"
    echo "$fmt_output"
    exit 1
fi
echo "    ✓ go fmt passed"

echo "    Running go vet..."
go vet ./...
echo "    ✓ go vet passed"

echo "    Running golangci-lint..."
golangci-lint run --timeout=5m
echo "    ✓ golangci-lint passed"

# 2. Test - same as CI Test job
echo ""
echo ">>> [2/5] Test"

echo "    Running tests with race detection..."
go test -race ./...
echo "    ✓ tests passed"

# 3. Build - same as CI Build job
echo ""
echo ">>> [3/5] Build"

echo "    Running go build..."
go build -v ./...
echo "    ✓ build passed"

# 4. Markdown Lint
echo ""
echo ">>> [4/5] Markdown Lint"

if command -v markdownlint &>/dev/null; then
    echo "    Running markdownlint..."
    markdownlint '**/*.md' --ignore node_modules --ignore .planning
    echo "    ✓ markdownlint passed"
else
    echo "    ⏭ markdownlint not installed, skipping"
fi

# 5. Security Scan - same as CI Security Scan job
echo ""
echo ">>> [5/5] Security Scan"

echo "    Running govulncheck..."
govulncheck ./...
echo "    ✓ govulncheck passed"

echo ""
echo "=== All pre-commit checks passed ==="
